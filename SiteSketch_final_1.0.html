<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <title>SiteSketch - Trassenaufnahme</title>
    <link href='https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap' rel='stylesheet'>
<style>
        :root {
            /* QFM Primärfarben */
            --primary: #003C71; --primary-light: #8998ab;
            /* QFM Sekundärfarben */
            --qfm-grau: #7c878e; --qfm-hellgrau: #d0d3d4;
            /* QFM Zusatzfarbe */
            --accent: #ed6d0f;
            /* QFM Text */
            --text: #3c3c3b; --text-secondary: #7c878e; --text-muted: #8998ab;
            /* Sonstige */
            --success: #00C853; --warning: #FFB300; --danger: #FF3D00;
            --bg: #F8FAFC; --bg-card: #FFFFFF;
            --border: #d0d3d4; --border-light: #F1F5F9;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius: 10px; --radius-lg: 16px;
            /* iOS Safe Areas */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { 
            height: 100%; 
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        body { 
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            height: 100%; 
            overflow: hidden;
            -webkit-text-size-adjust: 100%;
            overscroll-behavior-y: contain;
            font-weight: 300;
        }
        #app { 
            height: 100%; 
            display: flex; 
            flex-direction: column;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        
        .header { 
            background: var(--bg-card); 
            border-bottom: 1px solid var(--border); 
            padding: 10px 12px; 
            padding-left: calc(12px + var(--safe-left));
            padding-right: calc(12px + var(--safe-right));
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            gap: 8px;
            flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 8px; min-width: 0; flex: 1; }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 20px; color: var(--primary); }
        .logo img { height: 36px; width: auto; }
        .logo-icon { width: 36px; height: 36px; background: var(--primary); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
        .back-btn { display: none; width: 36px; height: 36px; border: none; background: var(--bg); border-radius: var(--radius); cursor: pointer; font-size: 18px; flex-shrink: 0; }
        .back-btn.visible { display: flex; align-items: center; justify-content: center; }
        .header-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
        .header-actions { display: flex; gap: 6px; flex-shrink: 0; }

        .btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            padding: 10px 18px; 
            border: none; 
            border-radius: var(--radius); 
            font-size: 14px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.2s;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            min-height: 44px;
            font-weight: 500;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover, .btn-primary:active { background: #002a50; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover, .btn-accent:active { background: #d45d0a; }
        .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--qfm-hellgrau); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }

        .main { 
            flex: 1; 
            overflow: hidden; 
            position: relative;
            min-height: 0;
        }
        .view { 
            position: absolute; 
            inset: 0; 
            overflow-y: auto; 
            padding: 20px;
            padding-left: calc(20px + var(--safe-left));
            padding-right: calc(20px + var(--safe-right));
            display: none;
            -webkit-overflow-scrolling: touch;
        }
        .view.active { display: block; }

        .search-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-input { 
            flex: 1; 
            min-width: 200px; 
            padding: 12px 16px; 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
        }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .filter-select { 
            padding: 12px 16px; 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            font-size: 16px; 
            min-width: 140px;
            -webkit-appearance: none;
            appearance: none;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 12px center;
            padding-right: 36px;
        }

        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
        .project-card { background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border); overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .project-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--primary); }
        .project-card-header { padding: 16px; border-bottom: 1px solid var(--border-light); }
        .project-card-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .project-card-subtitle { font-size: 13px; color: var(--text-secondary); }
        .project-card-meta { display: flex; gap: 12px; padding: 12px 16px; background: var(--bg); font-size: 12px; color: var(--text-muted); }
        .project-card-actions { display: flex; border-top: 1px solid var(--border-light); }
        .project-action-btn { flex: 1; padding: 12px; border: none; background: none; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; }
        .project-action-btn:hover { background: var(--primary-light); color: var(--primary); }
        .project-action-btn:not(:last-child) { border-right: 1px solid var(--border-light); }

        .status-badge { display: inline-flex; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status-offen { background: #FEF3C7; color: #D97706; }
        .status-in-arbeit { background: #DBEAFE; color: #2563EB; }
        .status-abgeschlossen { background: #D1FAE5; color: #059669; }

        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state h3 { font-size: 18px; margin-bottom: 8px; }
        .empty-state p { color: var(--text-secondary); margin-bottom: 20px; }

        .form-section { background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border); padding: 24px; margin-bottom: 20px; }
        .form-section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-label { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .form-label.required::after { content: ' *'; color: var(--danger); }
        .form-input, .form-textarea, .form-select { 
            padding: 10px 14px; 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
        }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; }

        .tabs { 
            display: flex; 
            background: var(--bg-card); 
            border-bottom: 1px solid var(--border); 
            padding: 0 20px;
            padding-left: calc(20px + var(--safe-left));
            padding-right: calc(20px + var(--safe-right));
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex-shrink: 0;
        }
        .tab { 
            padding: 14px 20px; 
            border: none; 
            background: none; 
            font-size: 14px; 
            font-weight: 500; 
            color: var(--text-secondary); 
            cursor: pointer; 
            position: relative;
            white-space: nowrap;
            min-height: 44px;
        }
        .tab.active { color: var(--primary); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--primary); }
        .tab-content { 
            display: none; 
            padding: 20px;
            padding-left: calc(20px + var(--safe-left));
            padding-right: calc(20px + var(--safe-right));
            height: calc(100% - 49px); 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-content.active { display: block; }

        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .photo-card { position: relative; aspect-ratio: 4/3; border-radius: var(--radius); overflow: hidden; background: var(--bg); border: 1px solid var(--border); cursor: pointer; }
        .photo-card:hover { box-shadow: var(--shadow); }
        .photo-card img { width: 100%; height: 100%; object-fit: cover; }
        .photo-card-badge { position: absolute; top: 8px; right: 8px; background: var(--primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; }
        .add-photo-card { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; border: 2px dashed var(--border); color: var(--text-secondary); font-size: 13px; }
        .add-photo-card:hover { border-color: var(--primary); color: var(--primary); }

        .map-container { 
            height: calc(100vh - 200px);
            width: 100%;
            position: relative;
        }
        .map-toolbar { 
            display: flex; 
            gap: 8px; 
            padding: 12px; 
            background: var(--bg-card); 
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }
        #map { 
            width: 100%;
            height: 100%;
            background: #E8E8E8;
            z-index: 1;
        }
        .leaflet-container {
            width: 100%;
            height: 100%;
            background: #E8E8E8;
        }
        .map-controls { 
            display: none; /* Leaflet has built-in controls */
        }
        .map-control-btn { 
            width: 44px; 
            height: 44px; 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            cursor: pointer; 
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .geocode-status { padding: 40px; text-align: center; color: var(--text-secondary); }
        .geocode-error { background: #FEF2F2; color: #DC2626; padding: 16px; border-radius: var(--radius); margin: 16px; text-align: center; }

        .quantity-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .quantity-table th, .quantity-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        .quantity-table th { background: var(--bg); font-weight: 600; font-size: 12px; text-transform: uppercase; }
        .quantity-input { width: 80px; padding: 6px; border: 1px solid var(--border); border-radius: 6px; text-align: right; }

        .editor-container { 
            position: fixed; 
            inset: 0; 
            background: var(--bg); 
            z-index: 1000; 
            display: none; 
            flex-direction: column;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        .editor-container.active { display: flex; }
        .editor-header { 
            background: var(--bg-card); 
            border-bottom: 1px solid var(--border); 
            padding: 12px 16px;
            padding-left: calc(16px + var(--safe-left));
            padding-right: calc(16px + var(--safe-right));
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 8px;
        }
        .editor-toolbar { 
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex; 
            flex-direction: column;
            gap: 2px; 
            background: var(--bg-card); 
            padding: 8px 4px;
            padding-left: calc(4px + var(--safe-left));
            border-radius: 0 12px 12px 0;
            border: 1px solid var(--border);
            border-left: none;
            box-shadow: var(--shadow-lg);
            z-index: 1200;
            max-height: 80vh;
            overflow-y: auto;
        }
        .editor-toolbar::-webkit-scrollbar { width: 0; }
        
        .toolbar-meta { 
            display: none; /* Versteckt - wird ins Flyout verschoben */
        }
        
        .tool-btn { 
            width: 44px; 
            height: 44px; 
            padding: 0;
            border: none; 
            background: transparent; 
            border-radius: 10px; 
            font-size: 18px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            color: var(--text);
            transition: all 0.15s;
        }
        .tool-btn:hover { background: var(--border-light); }
        .tool-btn.active { background: var(--primary); color: white; }
        .tool-btn .tool-label { display: none; }
        .tool-btn .tool-color { width: 24px; height: 24px; border-radius: 6px; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        
        .tool-flyout {
            position: fixed;
            left: 56px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1300;
            min-width: 160px;
            max-width: 280px;
        }
        .tool-flyout-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            padding: 4px 8px 8px;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 6px;
        }
        .tool-flyout-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.1s;
        }
        .tool-flyout-item:hover { background: var(--border-light); }
        .tool-flyout-item.active { background: var(--primary); color: white; }
        .tool-flyout-item .flyout-icon { font-size: 16px; width: 24px; text-align: center; }
        .tool-flyout-item .flyout-color { width: 18px; height: 18px; border-radius: 4px; border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        .tool-flyout-section {
            padding: 8px 0;
            border-top: 1px solid var(--border-light);
            margin-top: 6px;
        }
        .tool-flyout-section:first-child { border-top: none; margin-top: 0; padding-top: 0; }
        .tool-flyout-section-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            padding: 0 8px 6px;
        }
        
        .toolbar-settings {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 8px;
        }
        .toolbar-setting-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .toolbar-setting-row label {
            font-size: 11px;
            color: var(--text-secondary);
        }
        .toolbar-setting-row select,
        .toolbar-setting-row input[type="range"] {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 12px;
        }
        
        .editor-canvas-wrapper { 
            flex: 1; 
            overflow: auto; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #2A2A2A; 
            padding: 20px;
            padding-left: 70px; /* Platz für Toolbar */
            -webkit-overflow-scrolling: touch;
            min-height: 200px;
        }
        #editorCanvas { 
            display: block; 
            background: white; 
            box-shadow: var(--shadow-lg);
            touch-action: none;
        }
        
        .editor-zoom-controls {
            position: fixed;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 1100;
        }
        
        .editor-zoom-controls button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card);
            box-shadow: var(--shadow);
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            cursor: pointer;
        }
        
        .editor-zoom-controls button:hover {
            background: var(--primary);
            color: white;
        }
        }
        .editor-sidebar { width: 260px; background: var(--bg-card); border-left: 1px solid var(--border); padding: 16px; overflow-y: auto; }
        .sidebar-title { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 12px; }
        .trasse-props { position: absolute; top: 12px; right: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; box-shadow: var(--shadow-lg); display: none; z-index: 1100; width: 240px; }
        .trasse-props h4 { margin: 0 0 8px; font-size: 13px; }
        .trasse-props .row { display: flex; flex-direction: column; gap: 6px; }
        .trasse-props select { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); font-size: 12px; }
        .legend-item { display: flex; align-items: center; gap: 10px; padding: 6px 0; font-size: 13px; }
        .layer-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg); border-radius: 6px; margin-bottom: 4px; font-size: 12px; cursor: pointer; }
        .layer-item.selected { background: var(--primary-light); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: var(--radius-lg); max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; border: none; background: none; cursor: pointer; font-size: 20px; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

        .contact-list { display: flex; flex-direction: column; gap: 8px; }
        .contact-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: var(--radius); }
        .contact-avatar { width: 40px; height: 40px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .contact-info { flex: 1; }
        .contact-name { font-weight: 500; }
        .contact-role { font-size: 12px; color: var(--text-secondary); }

        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; }
        .toast { background: var(--text); color: white; padding: 12px 20px; border-radius: var(--radius); margin-top: 8px; animation: slideIn 0.3s; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .file-input-hidden { position: absolute; width: 1px; height: 1px; opacity: 0; }
        .flex { display: flex; }
        .gap-2 { gap: 8px; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .mb-4 { margin-bottom: 16px; }
        .mt-2 { margin-top: 8px; }
        .text-muted { color: var(--text-muted); }
        .text-center { text-align: center; }

        .geocode-results { border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .geocode-result-item { padding: 12px; border-bottom: 1px solid var(--border-light); cursor: pointer; }
        .geocode-result-item:hover { background: var(--primary-light); }
        .geocode-result-item:last-child { border-bottom: none; }

        @media (max-width: 768px) {
            .project-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .editor-sidebar { display: none; }
            
            /* Toolbar bleibt links, etwas schmaler */
            .editor-toolbar {
                padding: 6px 3px;
                gap: 1px;
            }
            
            .tool-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            /* Canvas Padding anpassen */
            .editor-canvas-wrapper {
                padding-left: 56px;
                padding-bottom: calc(20px + var(--safe-bottom));
                padding-top: 10px;
            }

            .editor-header {
                padding-left: 56px;
            }
            
            /* Flyout anpassen */
            .tool-flyout {
                left: 50px;
                max-width: calc(100vw - 70px);
            }
            
            /* Zoom Controls */
            .editor-zoom-controls {
                right: 8px;
                top: auto;
                bottom: calc(20px + var(--safe-bottom));
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="header-left">
                <button class="back-btn" id="backBtn" onclick="app.goBack()"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></button>
                <div class="logo"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMcAAAA8CAYAAADSUK4cAAABAGlDQ1BpY2MAABiVY2BgPMEABCwGDAy5eSVFQe5OChGRUQrsDxgYgRAMEpOLCxhwA6Cqb9cgai/r4lGHC3CmpBYnA+kPQKxSBLQcaKQIkC2SDmFrgNhJELYNiF1eUlACZAeA2EUhQc5AdgqQrZGOxE5CYicXFIHU9wDZNrk5pckIdzPwpOaFBgNpDiCWYShmCGJwZ3AC+R+iJH8RA4PFVwYG5gkIsaSZDAzbWxkYJG4hxFQWMDDwtzAwbDuPEEOESUFiUSJYiAWImdLSGBg+LWdg4I1kYBC+wMDAFQ0LCBxuUwC7zZ0hHwjTGXIYUoEingx5DMkMekCWEYMBgyGDGQCm1j8/yRb+6wAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH6gICExwBJNJ5TQAAPXZJREFUeNrtnXWYXsXZ/78zc/TxZ3037u4kJJAECBA0uDUFigXXQoEKhVKgQHGKeykULy6BQAgeEkiI+0Y26/v40ZHfHxvoywu0CW/7yyv7ua79a2fm3M/M+Y7c98wcoIsuuuiiiy52BPL/82Fq1XH47T0WbXAq7DwnSQHSN+QkwsNQ13Qdhq7xbCbXUJaMBwRhx/Spu2Rn7X8sf/S2C3HSDbfv7Lrq4v8Y/1ZxnHX6TNwz7wkcPuaMWFFF+wpEJ4UKE0IuBgaCVBGi6qSQuhKSUUpACZFcyLymaQJENVs6WUOpmG/raiENCktrsKU1tMrlX/782L/EPqUU5jx/LZl6wCFEj4xQgFKE0P8vFd/Ff3/+LeK47urL8KvfXo+DTvx5j4CbRzuOOjhQGOEpvYxLQqWUgFKghAIQIEqBQIGAQoJBgEMJBUoApimYjHgmDddqGnmVEe/lyphc3JwLnbkPXwSaGrbD9u02YxaIcA0jVrY31eyDdTMWVTyYV5Wis2donzWsi45Sv7zmhp3dNl3sZP6l4pg2/UB8Mft1ss+plw1qd3FM0cVRodSHhUJRqM6HMaYkozJvm3qz5HBKfjA0VNS0mQwqU/H3HMcr+EL087nqzoVKK0ADKCiloFTBoGEuGTXerkxF7uxRYX2cdyW/78ZfbLeN4/c6AiY8m1UM/nVRRM6TMBKdlgkZ1flKk3h3R1B4woils88/eP3Obp8udiLsX1HInbffhlJiAGLpykRi4O4/zZa0uwo+O9IVrFoJEI1CWrrYkIji2Zry2J1VSfOmAXWxP8Uj/iNeodTGCJsYChnR4c1J0vbLRg7u81DUIH+LWfQDjcoGTSOmUjIlJNW50Cw3xNCiGx7alvOqqAjXLF04N0vMNObOefMf2klBMWTSgQCz9nFI6uZAsmjaJB9WJrXljhfEch76uiH2A7Vq+9WVvTdiwt7+l5/O2dlt1MVO4r8sjiNnnoSb/ng9eXny9MEdRXpz0bcu8TipUgqwKAnjtvqkIoobKpP6b3vH809kfSz6lfO7xll3zS726TPCrTALn2tGPOOHmFrwye5+KPyDR/A3N7WFzcmEWjaxLJxNE/HnRMjnGVQpzWA9fQE7CGEHnE5yfL7PX557rbm9vb1+wMjJfM2ST37Q1pGTj0apaYOpJ3pd4xFztE2KS+Hl3i+4fLwOPxuzdN0J9VggyDAhwxVbW/NLNq/4eGe3URc7if/StOqw404BCzv0ojXwwIynXe+GbDCkAmFKWkx+Vh6x76lKslcZ65ZZv+llzH3xhe+U8dMTfo6xdRH20orM2XkRvYlQVSyPqlN4tOdL7Yv/hiUL3gMAnHfZtdBpaLSW9AkN7c7puZI4LOAsrgiBSUUpbuH+iji53oykW56447vTrL4Ddkf3kZMQFrL7h5Gavyqqp6Ky7VNP2v1cqVUCSiXjtvRCxfJuiKgeXtPuqCs2zb5xZ7dRFzuJHz1yHHP679C3tpatatN+nvHoLV5gdCdQ0LWwMW3J61IGv9y0zU/Wrlrsvfb0dahfueJ7y1ny1ScQZX2VJQtLoFm1njImh0KOtcLGT1J1fRvXLf4IADD/o3fxyYdzRf/BozelzfB1phmLJVQvKUl3IakRCjLJ90VP4bR+qvc7Lj9+aDnWrlzyzXPGT5qEMtphC6vy6pLUxykFcK5VhYomQAkIIcTxQxqGAoQoGOAL/Yoxb8WdLch3NOzsdupiJ/CjxDHxwJ+hlNmgr+mgs5zQusoTNKVRiZSlFsSM8Izy/IK/arGK4guPXo+t9cv/aXkbVi9Cz5F7cZ0EyyXR93Q5G0ohYhG+5Y1uA8by+lVffZN2xeJPMGHCBPHVBmd19xTeUErpnLCRgWR6KNgwXTMndS/PziNmvGP1os4pUbqsAtOnjAYP3P3SEbU3Yebqkq/iviRJSQkoGBQBOgdSCp0plNnBO2OmHfXe+o+fRa69Sxz/F9lhcUw/9ESU6SXd03udVQqNPwSKJE1CENXCl6pS9PRiSL6MWnH13JN37VC5iXgZVKpXxpTFjC/ogVzpgww9+pVP4ys3r/j2OuLLBZ+hbcPn6D9iUjGm++/qhJQA7OZKYXoh7eG5fi8ZFD7qPXRSfuOKz3HOGaeAGoaWybm/ZrJ0WN9ysSVU9EJFGFMSfQW4oQgFCAFRgE29xabMXpZZ80l20Ucv7+w26mInsUPiGD15BvTu41F0xWlFYd7oCzPGiEQqSl6ojrFzQIxNHasW4J23n95hQ5ob1qJHjzood9Naqid6BojuqiBrys3i6/2G7+qsXfb5d/KsWfIpJk+eJiYMqfx8/ZaWzVBsWiCIFQg1yKRmeVpz5/QeMilAshvWbc2Mj1iRMWURoscS9ksP3Hv341N23e013aCLAb0sFKKOg+gGEdxQucuFWTUvV/8lmhs37uw26mInsd0L8pbNr2HGGa+CgI/xEH3KVcZADRJxPXy3d5l25vjdBzc3bGlhGmPo2a07ZMlB4GWci39xaQhgu6PPex52FpTwhxdV6hVf6r1imnO5nZl7s28NFh+//ez35jno2JNQkQi0Rqfb+c1ZdbXHSdQgkqet4Pp5TYOv2Kt6SXWop58PFRsdNdRbcUve8NIjf/j8rIt/qxKmj1I+N6rDNc/dkLP2ggo22mH7MUKR9vdf+ddE4rv4n8l2i2Pvo84CUUFVLow/WAzMGVIpmDpF1MCXOlBiphnnQag0jSEatSEVhwJppIxl2lva6gMv8JKpJEknLbiO05CIJzNMU7KxuaWhurLCsywmMx0tbX0qo4Vbb/y9O+3I8y/LuNHrCOMdMZo5xYrXvLz802fQsG7199o37fBZsKhjZMKy6wqBcTEHQWVEPDFhzq0nfr7v+aeVUH53yMEoobB0sTFmyYejGu7vWPpqdtfdJj7sFNsOUZo9d32L/E15IrJoS6EB855/dWe3Txc7ke0SR/fh+2DghIPg57ael3dxWygYVUpBKQ4QAk2jMBjrnLMTAhAFJQUICChhCDiHVACjGkAplOJK74yZK8550TCYJIDkod8Ws+jWSMReRLi7rFgiF+VCNixq+q/Eaeuxnoy4H/zt/h+0c89DTgejojonE88qSYfYLHeIX3LWSbv2DZ9FxhoEvq5pIuA0QokSOsKFUd15sG+keV/fyR0EsD+tbtz667Rt8Tfemrez26aLncx2iWPvYy6AEsGwHE++6IasP1OhippklaHj80jUWmbZ9rrydDKQCvA8D0JwZDuy8LzAKi8v7110QuJ4TjISjZzU0uHU+lxBQUIjgK5pUorQkUK4hJAEIcykGgUFAkIYdwIRMagoJWjpHF63y2Phomex4NM3vtfOkdMOQMzsDUWCA0zDHFG7+e4/buxx3mUFmbxWKdAEyy0iRqKq4Ot1UilIpWBQ4tiMv9cvnas3w467TMtecff9D+3sdunivwHaP0uwy37HYc4zt2HqsZcdHQasPwiFrfGvapPk2AduOHXNAVcvky8O/xW6nb3me/Pvfcz5SETMRMEpndXiiGigKKKMOBEDC1PpyOyK8vLlhVxua0tLayYRT9ZpzBiSL3m7FgK+d8H16hQYQmhRrsXPrXBXzabDJjb+kDi+evcN7D9jJjgP344K9fbq1E/6SmmfJCSjNnOboOT6vI+RSgEgFJZGEAQ8UqLsoE1F8/pjnnpixTX9xu7sNunivwn/dOTY49AzoJQYUWTlb3iB0c1kgYjr7jlGvOq+ljWf4auPXvnefJU9+2DIuBMRt8IejfnCH1yh/8RgWpiw8WZFwr6nNq5/ujIyMWcvfgCvvf5379Yxp12GWFTXsgXWP5MvHVsKxMmuMHpJSmSlra6bWlV21aK2rHj5qT/8oM1Vfcfjopfn44XLL7gkoOkbBZMqKTte8ZAYVlJWf6qAyvIEXNdFoeQgHVGryyPBwUwz1rz44LU7u026+G/CP3TlDhw6BpHa3cCIOK4QGscopWBTb2EE7VcKL1v67O1nfjDv0Ek/g5JOXZHT+z2uHRk1aGt5FFf0q8VvQ+GveOzua/0NH/4Za9Ys+1a+ZV98hC8/myeHjZrUViVa5jHbfi8IZXUgyBAhyIhWN7NIUGttJBFDy5bvH63G73kUVs9+Ybg0ym8OmVUWof56Jnm7I6MTFSGIRyKorIijsakNjAoZZ951om7Gaxs/fwqtDet3dpt08d+EfzitKq/tB5pbUOVbfX4iBIXBAti6fI7FxzR3rHvnB/NNO/oMQOZqXVX3Jy8gB5qav7Ymbpw3IvH5W4sb6tRrz/9zF+lzj14PAGr0tGMWK+nNikX7UYcbh5aYflU0bFlRVdXzewMQgycdgEXv38FG7v3zsziifSm4ssLi4oK0x0sCMCVRV5NGe3sGQnLYjC9w8pufEIvvwfLP3t6hyjvjN3ego6PFNuN9+vrS7B1JJHpxQmkmk21Kx60GKcINSdbWVnIDvujTz7Dq/WfoQT+/50AjWbe/oRuaX8ovKbZtfDaeTLc8feOsf1sjH7D/IUhX1oFB2EU36CWE6B2PRXtTSrVcvrglEom0xWKRDfFotMnzfbFwwXwwSoxYrOyIVLpikmbqNqMy16tn3c2Msaarr/rVv83W/wqHzDgaq5vi6Ffl7BtPlh1s2bZFlJS1NWX3e6735S237tis4B+Kw0p1A+f+BE+wMURx6EQ0WEq9qgqb8MUH3z/vn3LQT8GLbSlu9LrCleTwhCGb0xb7Rd9Be7/57MvvYs2CHYsdFBpWo7Lfru0aCleYND4s5Mau0kyc+PHzN10zatIhavEn345gR+K16DP2Z6OKoXlkQDliyl0nKCmTyughCUFMZ3BLGbS152DpzE+YpXsj3Sa2LH338e22ad9jz4H02vW1Dd6eLDHoLIX0ZE6NpCqZhiIEUo9yz5cehNjcLsylptv0orn61ad2O+KctMMqr8kEZaOUJwFBfYqWDeDG69+qwwOPAAAKQAFQH7z+wnbb9p+Ztu8MOKHQ/Mat0zXNODsUdBwXsiyb9wxCACEUz+V9X9MyDRqln/foVvPiZ5/Off7II39Sls35Vza3ZgYromCZbFV1dfktlP3TZeqP5sabboLn+VoqlVJQSpx/3rk7lL+6pg4Tx1fqH3624qyGxtbDFQBDY65las86rrfD9vzjXxrtBc3dOoo7zCREgJJwfqF1zRoHie9NPuWgn6K2TLKmYt0pJV8/HTQIqcxf/eoLC1887jhgzYJPd9jAdasWIVHVHfqgI5dYzZ/fWZTs1rwvT9/18FmvUaJ9AQCHHXsGglI9ND2a5sV1foM2bCbnWjUzQs5UdqmjklOUoiCEQPICmlt8gDLENH8Oc5uey25ox6ZVi7fLnj2OuAheNmMmh+79iyKtuiRAPCkVgyIKkBIAgaJME5LFqNSGBCBDtGhIxo/v9cwin2kQps3BoJQEgSniyeoCIRST95pOe084pFse+kCNxCdolNRYaP+DrutNP1Yc+0w/GISEulLGuaGgV3oBTyp0BmLJ16fPQDQhQ80P1UBKMTBXchoJIc+dcNLpibyTSwVOCAKAWFrJtnVnO3w4282RRx2PQCQRtYNq1/UGfzZ/1S6GqQ9NxDI3QKnVO1wgJcg6vqYoSQspoBQgNeJKJVst29jh4n7wl47ZYwas7JtGQRs+UkqAMAVbV/Npr11Dd+Nn30nfe+gkDN/zVKz8+G8HF0LjV4FULKEH88ALT+6652A89ei3j52qrS/goIveR3W5HckU1RhGlBmz1Be+UZl11ryJl99895u0X37wKkaxOBgRTyJa/dNAGhNMFTu3Mmg8d9p+Mx2nWAKh1bUi8Ca6Zt+AkuSJQhEYvPCFhKlxYpZLohDTCOArFCWDRcNmTZWu5XafQq5+0XZVVln3fijvPxn59jWHlGjt5QGNRwHSuYuXiMA2maMxHX4QEF+IaMA0zZCSK7flb/U9L+LhmkUqQQLBqISAgiEKPMhs0hhjiFYPiOVE4qEiKqYGRDNt5a1K89YbSl74o1684cPHwbQSkCI4OOTyKilkAoqCEkDTSGjbtsMYU14Q6CHnkTDkxNC1Fkbx5EGHHoctW7aIINSFAgNRCkqio1u3msAPfpQ538ucee9j7OhDEfilS4JQnicVNzWdZizLvuPHlLe1sRGtbU3MdUNTqW3vmUSHVMgQsuOnM35QHIRZyPFYmWRsFEBACTwl/S+U14ovP/j2iTtCKUbvOQPrv3xheCHQrvUlKzcYl6byHmd2bbZ53cJvpT/61Ctx5OWf6cKMT1nXJs/wQnUAIDS9qOYbsv4hqSqfmbzfTP/Dt578Jk+p2IAeI49uc9uWPR8we0LUIJF0ukbv32sYlq34aqLg/sG84Py1pCd/E1Kj0mDCiUpvo6NVTheCghGJmK2QDW0wSET18B2vYcmC0Exh2efbt9YYOHp/ZJa8HNX67z3LJ5EoUxySUsRUZklc59eN6d9nZXkqTVZvaiINGadPKL29iZ+vKTY3vs8lIISb6VNlnmckouUBhAwzhfyylQ2fxlJRmJFU2hFmf4/aJiBAeWC0btmkBaH4US9eZVUNeFC0QczThSAJKAJKFCJRY3YqFb1/4MBB6xOJhKrfuDmezxX6ZjMde+gadRJxfWU+z6HphumH6ptXSkjZduasY/yzzvvXefOm77UnysoCY0M9BgsBUxEJwWVbqVRo/TFHjbp1qwOlSDtuY43n+wAAXdfdeCLt/JiLM35QHKlEGZQSZQXOEkIJGCpsUry0Jgy/a/TuB56G/Oa18SKJ/96V+jAAMHXSaGv8E6XyWP3F3L+n3edofPHQ70jtYRf+1FXkFjdUaQmAKACge9hEH2/r6d5GsOmGSXsfFnwy50UAwNoF8zBq+C4IouwLD+61FOGtNZ/eW5iXu+AQwsyrmJLX+TTdW7DYQYRSWHDeU0YsyUMtqSARNRnCIEQpkLBZ2KgJ9w6t27hg/gu3bHdl2WVpUKS7B1psuAQFVRIaXN/wt15tpPo8d9/VJ2HT2k7v2wN/eeYL5XW8uLnDNz9YtMTl0kREA13w7rPL+g4cyoaOHF5Gq2imSW8ObWtAyid2T6L0lIICkxSBlA2UUZKOV1UefebveVp25LJOKB2zCqXWLXqkrm/PSKpuiBeaUY0xpKPogF9afOAu6db6Vke99sxfIIQq54IPUIpAEcDQWamqPH2DlOrda3532Te/66ILL/5gzPBRT2zctMW44847vEOOOBmarnp6frFScQEQgFA0E5KWl//majzxh5nkwXcysULJs4YMGhJPJ9NszZoVrRdddGruySeeVU899ig5+qTTk4LLQZyLnoV8kVZWlAemZayqrqla297eEbiFduIFMrF5SyYpBMqVIpBKwdIN1qdX70EdHW1s//2PdMaMHZpjlPGIoaMiFSdvfrgg7ft+f0M3u5uGpRVLxUbd0Jt79Oje8OUXS0rd6mr0MJQGQECgwJhq79Gjxv/4w3llp59x0dhCoVQRBL5jmMbyIYMHbWhtbRN33vH9dwX8oDioEYOS0g0dwhUkiJJNFE42CL4tjhknXwqDhlZ9k/qNJ7QDFaHonOyJjQx+Q8GV36Rlmg4j1R+9jrhgr4zP/uBKkQah3/QRUgElqUdA1AVSr5yjRaxvnVGlPAOTYq4pg/c8YcQ+GHrJpZ40LjEUfzzbsnGuVT78r5wacarCvB4WNnmk8jilFAwGxBM6Ght9aITAZs5zS2bftaB6xAE71JNUlJVD8LBbB6NpKA4BCuK7Yb6ttSWfc/Di707A2J9eDgCYdfwxACAAOAAw+bhLASUH26khf27VKpKfbzLKLFX4vESqLvZY39sCM95TkmiCKgGqJLiyx5LUmDc9aNRX7XO9jR+eH518gc+2Lh3Beux+QYnFphdCq0aAaUQSZAvC15Sx+i8f5u+dWOM9WFNXF/LAq8pk3XIuxLb6lSXHc9uCgOO+hx7BGaeeDAC49babAYBv+4MfcGgUSSkVAwBCAE3TW8fueiBWr1iFlVIOIDBvo5T12bilOdrSkqW2Gbl1+vSDbt5774PNKdMPPbyxqf1cztUIKVRcSgnXa5Gaxto2N7Q+XZaO3lieSLS0bGq5qejwPYQk3RQIlFLwA957yZKVfyuVnKxlaCt8Pzw5n880bdzckDQMc5bj8eNCLvsTiBglHhVSOpQGecfZsHJAv16/rt9Y3xGEVAd0gAjoGnXenzvv5GLJPSGbbxoZhsKUUgjGaKPrLbtzyOA+t8068+LwgXtv/q4GfuhFYDqBVP4AEFUGKEihttDsikI+m/8mzW4HzESuaZ3V2KbO9JRxjs6kF9XESiUFqOJtxZYVbltbxzfph07YD/mWxUlXyF8GSqv5+vwE0OmWIQSghMIRejkn5omp3GJj4tT9v8m/ftlyZA+6j2dFql+HrLy3JKxrGMTKpN94Q7yi7wE+9KlKASZKi0IWGcMF0hIc1RUJKGnAFxwxg29K6OqhSYddIlfOfwM7Qsl14Pp+hnPuKAUoJSCoFTMqBv8+Wl53wrULExOOPfe2bjNP/a0JgFhp85u80VQVIvFUnbTLBvsk1qvFZfG8Jzm17MrAsEdLFutDCWMMgABBCCPi0fTgkNgDjUi58cqbb/r1KxaML2k9n3DNqlMdmujhCVOXnJCQU1KQhpWT1sisSl0/vzV6JE8OhcaYQwjxvn7BuVBVxVJwu2mYJ3z8/vxxp806t/amW/5kAMCCL//ukLBME9Go1Y1SQlXndgIkkykoxZEpZKras8U/+AE5gDF9sBCqu1D8daXIn084/pSEaUavC0LykFPiu/seT4ShIFIo4vuClZywupD3zm9rLdxImF0nFZsQcgyAQgSdFQo/9GlrJpt0g6AXM4zILuPG5jdt3lwlJbs7Xwj/4HpiHOdIhlwwP+SECxkNAlkbhnKsZUVRVVldaehGnBABKMB1w8m5gn+z48sJBde3/CAgIRea54c9Ojqyv1q7buMeK1au+t72/sGRw3E4fNfvJqmMUgVYBktFI32YzTt7l6n7nYh5k36J3Rc9eHCJ02sIYEeYf20pYCUG7XpC1PJ5jefz8d3/7mlJxsugMxotCq2HhAJVgCTbplREgSiCzpusGBiz9w2TAyrNgDcAwOHHnom0pYwVT/1ib06S1wVKGx3Rwq+qYsH5mzfkJElXny1BDYN4mSgTfg6JXUOpYOkmopEoVq/bAoMpaNR5qL3nUYtja3Z8O3pzcwN05aw3e/ZaEdL07lAKAibyrGIqlcHkoooVmaZazVTdsqMu/fMbUaPwytZ6p2HXfVL4/CsB6aFMUt2Q227ogkQ7Y3GlWXYHh5C+UGmlAAUKUw+LkiJHVMikV1i+/0/O7OaWT7qzRMtGSKWgkxAxFqywNTXfB+2ZC7QpXOiaq/REgRgX1KbpW6WG0mZK1AoQ1KjOo45wnWBP3w+nZPO0SBlrasssXH7CSWe9fP99D798/Amnd5SVx7F8VQM8V0LKzlGfQEHwoKN7OfQOh10lBDkCCqBMIha136muTv/O83hrU1vmAt/nF/Cwc8SxTa09nU7MJ4S2tbZmpgZc9uJCwnX9w7KF4juGrmdiEdLqBn45hKQKBJaphZpG2wDQZDK+vKw8ESqlXeL74UwpWedmVk0GtqU3CqEaAVIuuOxpGtpn06fvufChh5+YLCQoCAGg4DpBgmoMhs4KhKIYeEE5l8ogUAhCpDwvPPjDua++c+PNd+PSi8/evpFDgUJhm/xU5+2ARChAAn+868/waAx7fXn3XqVAuzWUiMY179Eq3fmDZhqh0ggcP9TU6hOxtaX9mzK9Uh4RlWvXqFhLOosFlIICQBUFCMCZAqUMtmG6hqUL3dAw5cyHUVB6r/V++mYHsScdqY9Omur9yjg5mcX3+MJM9jiRC32CUhLMyy7Mh0YvITWTKCCVSqKlLQNfcNiMf2XB/3Ni47OY+8qjOyyOYuNSdN/tslxMFW62ZK5FUQVBOutGKJ26yk4Uid2vQ6UOaQrL724Mqp6v7F03zbhiFsnkfLTlfPBQQUKBKAWGsBR1N30yure9R0K23cdECKUASgSqrPzTI2rV5GE9zN17xwr3hbGhP+FacldJFJiSSNDcvKTYcmibbpzUx95ylCYK73MISAgEyuivVKKn2X1cKR6P3GMZWqYzYgIoKHAhmReIpOuFgzoypcMbtnY8sLmh9RkwY9ynC5fD9SR8z4urba5pSolgTLUEMvILKchpUnTaGLH195iGWY2NTQ35XGvPIOCzwhBMgcAw6IZEKjZzl12GH97U1nFiPGFfqWlUKgBcqEgmk68aP27UMd17VZ+l6cSTACghKE+n3p00cdwe48eN3m3q1N1/c/+9j4/kXP5MSgVAwtRJWJ6M3zhm1PCpu4wZMX3okH579epZdXB1dfJ3f7zpjiCXz+lCCPL1gt6ytWxtVfLWAf16HTh4QJ/JyUTkDkYpFBhUp5O679amRi2ZTH6nvX9QHKalw7LNEqFUKBCAQCO6wSyT4elXP0LEZnW50LiSS3SPkXB2Oub8Nl851I1Zso5QCsOwdp924GGJuqry/6A4F5sH3+SbmlxKSeeu2K+lqLaZY1MSlNvktcqUfX7KaGhJJ1KWnV92rMfSL+ZF9FzCqF0R54/bhnNivlT8omnDS/2EETudM5PaNGg3DEI5jfaVACKWBaI4WjsKsJj0I5r/p1T3YfVrl3+5w8IAgFWfzUPjB3fitT+d82IZLZ5RpvufWggdTXIQJUCVApMKVAqESiOFILFrR8l86POD/jgyEatC0orVEaJ1djRSgUCs08edV/pii7W5I5NzuACIEJBSIl8sreqonFa//INX129avVApIz0jhA2pAE35vlZquOvp30/aeMVkI9rS2M647/kaAEIoJCU60aO6VdUXw4cN+Vsibp8Yj+jzTJ24+Ca+0SlqKSXCkGvFor93W1vmtuED+1S2Z12Yptmts3kUGGNChOKYghNerJTSKVPQDbq8oixxKQQ26roOSo3JSmEIIQSMEcSTsSdffP7V2XY86R996GSdUqJ3HmcAJBRc11PvvDuvpalhS5YH/OvgC6QUK6656tI1ffrUrX/myefbuVD7c66qvnaZ27bxXMLWrl+3cvWmP95wZeGu269vePzRe9559KG7Pk4mUyhPp3pTSgyozil6dXXF4888/eAlgwb0+rCttWV9Ima/rjPmEWybxlPKa6troOv6d9r7W9Oq/fffHwBMwzCMolcsEClbAeopIqOGqdcZiZpkMk4c246mWkvGDZ7EHnFDrqiy5aWWXdPg5VtBZTCfkjgHQ29B47WWQb9ZpCz46C1Mrb4NUorHdBYeHgg28OvgHGNA1MDy8qj2J4vm//K0+FNxz9wpg5SVPLvEyakcWsRmqtHWgmtN5T1Cie7kUrvBDD8+3Ff2AE2jSOt8TbuXGKAk0QiAmqo02lqzUIrApv6Hdtj6Qri+oUeZzhvsAcPlqjVLd1ggH716N4476VR16i0nvvTa7/48r8mIji5wYzSVcnig2BCfq2GuMOKAhARFEWbvuFWzLykbuFi5mTIQum2BpWBrzAvcdmTPn4LEVV/VhkRBgoAoxTU9udpZ/S5gJ+GSZIWgRl/S2dNBUAqa7n3pT29pOV8qIBsZGZVCG6aICQIFixR9t6Oe66aN+uZ1PFWWfrW6inxUKHmjXS/cJQjCQWHIR/pBOCzkPNKpAQLX9XfNFbzde/eofbGY22oqMAAEnEu9PVM8QimmEQCmqTfHoubPU+XVC9ralyKb15GIk1FCEtp5pgdwiv7kyVOnPPDc069Q07TqgjAcx7mklBDoOlHV1RWZTDYHw9BrCw43leoUbTQSKdV0G4l3352HPfYepX366cqxQgKq89wQr6hMP5vPF0ovvfjEd9rG81xwznT5dTAWCo7jLNtl1+ly4fy3cdCMmWCMWkIp2hn3IPBcZwOzevLHHvluaOUbcfz2yqthWVa8vn7DiC2bN67XiFOA0vKMKk8RRB1fmG1BYKxqCjFsQNWJhVDNtLUwZ1H3VwVULm5e/xESZQMAJRYaFFuF0nqE0h5nRmLfWu20Nq3Cio9nr5w+8+JZlktOdUK1H6MKKdt4xNb4vQ2utbHGRvlexV+f4jJ2qeuxgVRBxk0xxzb839V/8MpHiR6DZKy8ErHsm6MCu/YspTREqdMYhCSQUu+uAEQjBEKEyBV82Ab3TRo+IEN0s5Ll4ybsu/sjH/+HGMqO8tSjD+EpQOHKEzsAvPvSO5+8y502+vlGFdvQkJnYFOo3eTQ5ggKQhEFSOoO9e+59ZPDJ5XKbOAQkd0O5Wcp2LKkhdPLZD6QooZASoERo1G+rTiT7wI/GoaSoCYielISAQoFL02x09HFwOgcBCQuKUGg0gE7CPC+23ppZ8+YylR6EOc898LXZGQDv/eWxJ96zDEa/XLousWrtur3aO/I3B6HqAwBSQTdNe8LYURVvvDuvvYdwBQACqRQJAqERaAAR0BhtrKhILynkOhAKH337bKUtrT17K3ROjaVS8PxwD4DsIRVQdDxsm55BYyRIxO1XYnHztVyBwHGdiJSdCyKpFIrFYn2f3j1hmxYaGzoiQsg6ENLZn1CatyPmBtP6brT7zLMuwFtvz8eIYX27l1y3cw1LiIJCprKiAgDAOQdlehnQOYoRAkQidlhVlcYJMw//fnEcf8JJ2LBhQyqRSO5nWfbCS37x66ZfXnc7dI22SBZrg9LLhSTlgtKaof3q9FwJ5wCSxvXw9m5k4ysdfglz33sLYyZHYRGvQU8bS0sy2lMn9n5h/ZvPjp08Pfziw9kAgBUfzwYA1a2qbB7h4SdtjjtcZ4Smw44vW6QVqzDocUW/8vSSsqaEVGi25jUkKL/HJOF9itht0fIatOXasfDDv9HxM845JZRWX0YkNCpJ0dPHcQVCmUBlWQUamzqgEMAk3huGbHuroFJXhY7cktvahqVLv/jR4vjPHLrPJACQ502J5sOTi7PNLx96NySJEZ3TfAouRIToSTNqR6odaCAQYOCMOxnLTjD0qgL1Q2UqnXWuR6TvFh13U9jaAMM0IUUYU4SZUJ3eC8tQbsTQN1FKhVSKcEgJ7jfahC/XgvaXGxu/mJfoNTl86+HffcfW43/2UwCQRxx5THbq+MqXZn8UHBNyt4/atq6EQiKbdXVCaLTTEw1YllGIRcxSW1u+BoTCD8Wo9o7c2cceM+OqDz78lD/99K0YNKiCMD3W+YupEtFIZCOjzCOEEqUEQu47lmWvsCzrpbqaytkb6jfmW9uyoERaoDYIoWAMiNgRp6KiAulUEprGbF1vSwMhCAGkVMVsJpv7vgBhtr0DG9ZuwZBBPdNKdQpNNxiqq6tRKBQAACEPAcgIFEinOCjsSKSg69/vl9I++Ohj3HHbrUimy6dxHrbF44m11113LYpFjojuZ1m8opHCHMQlbKX0PiVPzvRCOTCu+bNjRsed7apavPlUZ+9ULHWgfPhULyy1veBwuX8gzf2smikjLKG+8yY+ctuvASA88LiLvnS9kpHRE1O4Fv1lSZh7hZIamsb9NPOeLbNw0+CksygrE/K+268GAEw56iLU9hw4xKfxg6Ui0JSEJ+xKH5xJCNimhZIbwPEELI3nqXDvcJDoLbToQa7kZ4Whwo9hxk/PgxQqkkjVpSaNHd0oeVZdePbMb/7/FjkYuHmA0W2vX/cAWOdUAAoUcu3SD94s9Ol3HIHdOX0gIC5TYQcJshg+/ZSIE432yIMCVECDolQ4nIZAGPqAkjlowiWaMhQhsGj41bQ+xrG1tb1KXhiSfFhS+bYNxSvPPNxvae1Q1VWn4uhjjsNRRx8Xqa6pSe62+4Tm1pZWeeH5F3xja6Hg4b2Pm6Kc63VKKSgoEBCUHGdRexu3lULi6zWHkrzeMu1rTZPe6YeqUihCHCc4940358zftKnx5UvPmaJmf2R7oQCUImCM8l69e/xi0i5j3nM9T1NKIpttDwcM7FU4+qijhVIKhBAMHLYvevcs61t0xbalkHKF4o2EKrR3tMO2WT4IggZCySAAYIxWRuPpfp7nbfhO41AND999Cv3zc0vsv69k4SglG7VtL3+x6CMesxKda+hOb1Yul9s0sF8fbF7/3c5Se+SRvyAaK6sWQpFMrvX9klfCO2+/jp79h2P475c4W54676tQqT0lNGYlK2e15PgwRsJAV86DJVHVFm76++J2zZdzUVnTFxoRL8eN2KkFpU0KWdkFJs1esMcR52bff+FPAIA+VXFMPfcBZNd9kOIytlshjPw04NqBPNBSVJNh1JAflUVxD3NyL0LFSjfcets3z5iyx1iMH78n2tZ9dHx9xqwIGGkLuEyVfKVBKZBtPWBzew6KSkQ0+UIsv/jjZn38FczSVTKCFYTs+JaMIbvtB7P/VBTbNh6Wiw66/M3V/gs6oR+dfd1fm6lGW0u+Q5iM1Wxu3OOAIk1OU0SDIgCFgB4UP+s7cQIjul5GSeeSg4KWoMhmN98OP1eiJCkZDApNAYyYsG3LevXun5PzrrvKXLs2bNIIb+UgSSgFN8TAdxevG7LptGmzD/rj7fLUfl/SG9f0MI+8YMvESDxZ9shzn7/x0l/vkgrhEWvXt16+of6NNxNx/ZPzL/jlGsdxW7gICNO0us2bGo92/WCXTg1Q6Dpts21tYcHxTSmV3RnhAHSNycGDB80Jlqx4sCNT+iWXCr4vkh3txV8PGjjgy7nzt26G8ldASQAUoVBmc3PT7qVs6+vnXHSu98JLT5G67oPZC397vWbGYceOOv5np352/M9Oa29qMlAsbGZEM7d1GNBC7lW89MJj5Kabbzd1g4utTcXNfuBCKgUhlN3e1n5EXWXiE6WUc9PNN5CvvtoQF4IPraut3VDfbHVEovGaIF8EAQFjNNQMVogZEQDAlq0ZTBo/pGdLRwFSKVBCkE4lVY5+v19Ki0YTKJWcnkKEDZXlPfi9d3dGCjetXYqhr10OjcmPNCHO8jjV20pqWigJ4pozJ6Jn3/IDBx9++u19SR1bVqBmxLRWzc9db5HEE5Syo1KGNbdy4J6P1OqtaEnPQIVYWtWwfOE+LspO80JtN5/DpAwyFlPLkpa6TwsLTyzLD+y4tNu7uPm1r7D7jDOhUy+pa5GDwL05t1x2aPurL9w6yAvIwi1tWPns+017eEob+rUNnhNAKAWLeVtlmL9dlY8brIfRn5lMrdCLGzJZ90fss0l3w8r37o1UjjrxJx5iI4iSI6gKPCdHHQW0ExIhIFqFE40nJAxKoEAhwHjmU5Hd8my6x652STfLwm27lTQoYmmEchB4hCtCRKdTmxIEsEwe73ftIZe/dLqmK5lILLtEBLl3fBrvD8LgwkxTrfbB7hc+OW9pS6T+smzPWsdAT5caYyOB2PLyux8uLLRuzMOuON7xyDBG1DDP9XguH+aE4G0KkhBCqrxQJiVACCgoUTB19vqIod2XfPDJsj4hF51vLBTCMGwvlorFaNS+03X8qSUn2B2gcJxwQlNT689vv/U3l1x8ye8/LrpBIeQyDkmQzRTOfHve58OPm3nG4qeeeo9xIfvmC8UhnPNuVoTNLJVKrxQdH7ZlINy2iUKC6J4vrznh5POOD8JQr6mqvCJqW7OLJXdmECpdSiCbLZ7sef6Q6Qce96VSKg7JhhOKIXbMO08I7xkpRYRsm3YppfKE0DwhBLNOPRMPPHQvSsN62krJbW5tEoKQAv0hcQhioOBmBwBkKzU6E40ePRpVVVWkTq1lm2TiY8BaDmCUF3AYVMJk8gXH6J9vXvrdCPPKJZ+gtu8whGE4p64qepVhmuuq7OSHaHmNhWav/nph2aGbPRzpCGusANN0ijBly0/TSf3ppI3nHl/4m4az+56iXnlmFv48dU/kVreR6kFhX1elfpMr8sMs4R9y7mkHLa+IkYE9uiWGFTx74AeLts51AmITKJsLWREqU2MkAOHuQ3r948u8gWfdIwm6a8q7R3af5jS9de8Oi6Om1zBIv/ckj6b2EFxuG5ZNKxSwiCJlFJ2LREUIJCQYUYgrd4Mms79UFT0bii0ru4Wh0qXeGeAJuOMWC4W8AkcKmxyH0ZWB4uMUoSCgyInoSFBtZFSIhrryvsLYsvleQ6WmeSQ9EApwidXNpfZPiJBQDkDAICig0QDVFRW1JF07vj0fTFWKQ4LCC6F5vFROCMrxdYyJAFAKGlFIxKyPKeG/+2LxRh6PJ+ocL5tAyDu7c13rmHni0eFvLvtDo21p1/hB+CQPZVpIgpLjn37l726fP2r0gOe/WLT6CeXwM4UgCLiKtGUL00m2NF2h02UsZafL3vfFhLnvL3hl8qRdEInEV2TzJXDRWaWlkj+wVGoeaBgmr62uu0sK70VK5YtQ4mgFBiFhOS7fEwR7Kqk63eJEwvP9sT27dZuj6201Ct+sn4q+7xUoYYilUvjTXXeac95b2KvgdI4cSgkv05Ft/DqQ8J+hrW3tcP2gvuj5e361ZkN02mGnAgAKhQKKIRs2bmDluJStNts6aYybdGvSpgtsncyxeA4rlyz43kLfe+lBjBlYXkrw9bcyEnxSX6ATlnfU3dnkmm815ukNWVdOgPJzaYv/rXsZ+Vl1PDhI1+htTZvWbiEfQH2xcTVGTv894lUDyvodfNaxBRl5ORtoJ3FFwzBER+9e3XpEIpE6xnTELFV92fFDt5y8d+0Zuw+yZiZMd6lSHBFdLImy4GGv25FjC5wdzqVoCtyOV3MbF2D9umXYUaoTKZRHIxuSmn9HRHMX6VQVDKoUJRKEKRAmwTQOk4UioYnGJDoej4WNR2258+z3o5qLqm69ymO2FaOEBwwihHKL7W31YWPjJqD/eSH1MrdbtLBYo6Gk4KBKgigOiNB3cwFi1SMWx3nmtDTNzzVZ6OrgYEoCkKCEwyCBihE/a4jchx1NGx3DNL5KpuK3JGLWAkMnOcaIooSCEApKKBgIdEq5bepb43Hrhu7dqmbGO57eUCjmkc1kGJTgGqO+RplIl6XDccNHqr4DeqC81njbMOjDGqMhI8QXXBj5XP7ifMat7V5ddmV5KnarbWkNhsYUBQNRAJEAIxSWqRdjEWu+ZRpLnexq1NWlkUxG/pZM2K9YJuMaoWDo/NOoEq6bF0w3HVNTl0Rt/VHToFmNUVBCQBXZNnVSMmIbW8MgXFe/cSPjoa80hlCjhCeikWDU8BFq1IjhaGxux5Jl6+B6nqCECgIEhs78nr26yZ49u33/yNHU3IgIcz6VkV5jytI1N0Qi1h1uv93WVJhUZVpWLpm464S1Vdmm+dV61NINkxgEXmt9Y5MXfPucwUPPvoTzfvF7HHbwPnZbxu2+dCsZpbRB04O8MdUP0DsMNBOEe3FTrTKpeC8Zp0/0qbEWtDnw/nxr52UJl//+Fgzue4W2bmumkvOW/UoiOauo6C4c1KitSqI2xVq++GRLc6q8x162pSWJIjA1pfWsNi+p3oudoGS0eVl9Te8n5zTXr68vXUtb39giyg//VQCzLKH5r1pBw6pcYO+wMADgL9efikt+e+36qPjwty3JabfleDAgorNhjkeq41GrB4hQnudu0hjZSILsQplbU4+I7X8FYIQZAVFyQ0XcOjaiNF1JDo3rpVJlotUNBLob67DwiKs+7/vmE4eCRCZJEfaMRI3uRd9dq0EspgW/0etYC6164AdV4ZYjfMscpxQdFbGNflIp4pXcjTELzVz6S0ptW1dUDBxRirW4qKkpv6KpMXNzS0t7f0W04VzwnrFYtE4KKfK53AamkTXRWHRFodS+PlfKhH/9EJhxKIWUclEsljhMCkIJIaS6srwZgDrqiCPx4AMPi/Ly1I2+x1/nXBAlFRiVMEzdpSzWMmDgkEtXrF7zABSdKJUcGLHtctf1WqUQDZZtLq+srFx03TW/zB111CGY885s2Ha0sawsfUomk5+iJBkdjUUrfS/YEIvZDWXpxKesezds2LhxE4AzCaH38UCMY4wN0DRm5ArFDYSiqaa66rNp0/ZZ/9gj92iJhH1SJBqxOBcoT6dKdTWVeUIZpAiRz+fCZDz264ilbgl4qCxT4z171K1W6vtHDgIAu+13MjzHs2q6154P0zpKSjrfIGx2eSq6Il1mtU7fc5egdcum8NmnHxKnzLrELLo6XbZiFckXi4lMPkg6XNbmCsU+iujDSr4Y7HM1ioNWUco0SnXYGnKJiFomPW+x4GGvbMkrtwwjZzKx1jQjq6urygTTdTS2ZDQu1NiC6433OeknhKYrIsEYRXkqDpuVFrz+1+f3fPaB4y6cMLrnNRGdoTOoJkAgISRFe0F8/PnK3IU/O+nCBbsedMZPPJK6X6O6kWJtJ5mxyidff/omIHB/lEC6+L+FBgAfv/UIjjn7Ck+n4paCTz5zXDKr4Mk/driFCFq9juWbP/GckttewKTMfS8t7aUImOsGhPOwwuciyQVJCmHrFJ271QmBbzHaaNBwcSyqzSszyHwunXPrPXVi4CMqFYPrAoxp0/VQos3LAISA886jjUJ1bl8mCAGlEAqJrc0+0qbbAH+5Lzmp8AMC26IgQkAoiTCQfnNH8bHlKzNX3/TogpbdZpx9ko/oNUJp0aTO32aB/3qxfUuXMLrYbr4TTTn/13fA1oS+YH1HT8nFrpREdiGGMVAp2Y1petLzgjDggSLbvmlBqKIq5G2WobeYGqm3DNTrGl2WjFrrdF7aWjZwivfhOy+C8ODAgor8NZA0UWnzBVY0+rLLaVoD6WXoht05F/7aIvWNcRKAUhKQksHPvLZq8byHB42a8GIyFd/7yL3qMHFYCr4ftm9pKv3x1dnv3XHjbX/zph93yXntjn6dr/SoTcN2mxaPpkbivVUf/xWNm7uu3uli+/iHZxGv+uVFSKUSZMLUA7XF6xujnudH163ZMIlqZeVbt24tRiJmqbo6tdAkLLPnmJH+/IXv8Vwup264+dsnqybveyQs1aG79tA7s9w+w6JyY1wrzHBlYskj15+qd+/Wk9gRW2n6D7tYXdcjtm2F+8+Y2TdLK+bkQrtXbUJg5j61K3uV44KH758/py3aTfihv69HE0+6Uq/QKZDUvbuHJjouaFOV/JmHu74O28X2s90HdUeOGonFixbjwJkXXFLwotdkHF8aFH5ED25O6R03QYt5rz39w5c8TzvoZEDxIXlS/oojrH4xVnhCyy07LaBJb8G8l7bLhr0PPQWCB1PzquI1Se2opQVzosS5eM4K+6uf7jcEhY7VI9o94+5cQCcTxZA0vY9TevF4ppkbXvrzzdv1jC66+Jrt/nhNc3Mz3l24CeDuMl/R/k7IxgSSWITauxlm3IRo/aT/sInhuuXfv2fJSqSRGHxRGystJz7VpgvJ+uuGuV5P9v4qagBtzZv+qQ3V/SfCC+R+TI8cHDfkLTVJfrGmRTdURAwUs2v7uog8VuLmbkox2LrcmiCFswVLLmpeOQeNW7fu7Lru4n8YOxQqnjLYQ8ZROcZzl6Zt+YGmKThCWBmPXhKg9iLLNNgBM3/xvXlXLHwPtO0Z2Lr/eNII3wRjUWlUnlselT37jZyyXc+vralAKspI0gouqU3RK3koWzNeFEy0jJFG+rFiYEwQksAgXjZC879+85mB86JaEQsXLNiu8rvo4j+yQ589++DjpRg1fCSUXZZP2nShAsaFinYLpcZCRcd6Aimn1LG8duCEwtY1C7+TP9u6GdV9hrkmCZeHiu7jSnOkFGFclDa933voRL9+5T/eKXvrnTdi66a1S5MxMj+fz4ZB83LKkhX7lUjyPkea45RiJGJIL665f1j59q13P/GmKd97+dGdXcdd/A9lhz+YuXbVVxjYvy9ErHdzVPPnKkF6cqEP5gqWUPpuum7tUlMWzYwdO6J+2LjJYtmXf7/l0HWKqOzWG+XdRzbxUkuzJNq+LtcmMp0VP3jxqw/PveLnmD/vrR989hMPP4iOtpxI9dtDlfK58qLR65KisK9zpN1bKkCnYUfC4BcN6xu9v2bQ7uHsZ+/fnp/URRffy4/61PK6VUtB/PXQ40M6Yob/ISWyTEgyjEuNCaX1DiUOFtTsLrhYNan500z13kdj3arOTy43rF+OQf17oF+lv6qjQKxAGnsKog8aPLK6qWXhX1eU9RimGrd8d/0xetIkHHn8Vaipq0i5Hj8yy+3rPRU5IRB6XCMCcV2sj1ulCxs2zf3rluZS+M7TD+zoz+qii2+x49fK/Sd2P+RkaCSMUavmrIKnXeRxVisgoVPAInKVSYOnKsqiL9iav9KIJINHb/sNAOCg4y4Ag0jlQuvmrM9OYVS1xLTg5MMm17755bqCfPyuawAAx592AeIWaJNrV+aKfB9B7NPdkE30BIzOg+1Cmsx/ozxlXPlq8uqF+9bPwtvPP7iz67WL/wX8l8UBAMed+nPE9RxtyKR2zQvj8kIg9w9CYkgo6JQgYtBmW5cfxiL6XDtifVqdsjcWmtd3NGUDAemlckHiBo/ETtM0tMb04NaYdB8cM7R/cWVTR63PMdr31d6lEHsWfTIwkMwAoTCYQswmDUlT3RMWmu+NpyraX3jomp1dn138L+JfIg4AGD91Mmr77g6qSnHHix1ZEvTCoiOGcUk1RTs/nKlpRFkGyZma2hz6xWVSYHlNbXkpGbMqtraUTt3a4VUZkDxi4HNNN3JuIAeFinTnUupKbLvRigIRQ2+JRtULFUn9/lrVvNi3KuXdN125s+uyi/9l/MvE8TU33HA7duubJ098atXUN+amu4LPLIWYGIQkwSUDUQwgEooIUAVoGoFGCaQEAt556lp9cwtHp4mUKuhUhRHLWBcztRfKU+y5ar24hFgpfsu1l+7sOuzifyn/cnF8za8uPAnXvdIDZx5hRAseG11wwz1yjtiVczKMC1UTCGULKenXp7I6j0kq0M4rQZWuaaHO0KFrbI1tsYUWC+elUvZnvSJ+U8YJ5W1/7JpCdfHv5d8mjv/I/X+6DbPOuYDcdPdjelPGr/Z83jtf8roLyfp0ZPJaqVgCoQS6xlBelpJKqk3labvVMrT1MVtvGNurqVTZbYyaMuWgnV1fXXTRRRdddNFFF1100UUXXXTxL+H/AYYsYzHgmusxAAAAHnRFWHRpY2M6Y29weXJpZ2h0AEdvb2dsZSBJbmMuIDIwMTasCzM4AAAAFHRFWHRpY2M6ZGVzY3JpcHRpb24Ac1JHQrqQcwcAAAAASUVORK5CYII=" alt="SiteSketch"></div>
                <span class="header-title" id="headerTitle"></span>
            </div>
            <div class="header-actions" id="headerActions"></div>
        </header>
        <main class="main">
            <div class="view active" id="projectListView">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Projekte durchsuchen..." id="searchInput" oninput="app.filterProjects()">
                    <select class="filter-select" id="statusFilter" onchange="app.filterProjects()">
                        <option value="">Alle Status</option>
                        <option value="offen">Offen</option>
                        <option value="in-arbeit">In Arbeit</option>
                        <option value="abgeschlossen">Abgeschlossen</option>
                    </select>
                    <button class="btn btn-primary" onclick="app.showCreateProject()">+ Neues Projekt</button>
                </div>
                <div class="project-grid" id="projectGrid"></div>
            </div>
            <div class="view" id="projectFormView">
                <form id="projectForm" onsubmit="app.saveProject(event)">
                    <div class="form-section">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="form-section-title" style="margin:0"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg> Projektdaten</h3>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="app.autoFillProject()" style="background:#d0d3d4;color:#003C71"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/><path d="M11 6.2L9.7 5"/><path d="M11 11.8L9.7 13"/><line x1="3" y1="21" x2="15" y2="9"/></svg> Beispieldaten</button>
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label required">Projektnummer</label><input type="text" class="form-input" name="projectNumber" required oninput="app.updateProjectName()"></div>
                            <div class="form-group"><label class="form-label required">Projektname</label><input type="text" class="form-input" name="projectName" required></div>
                            <div class="form-group"><label class="form-label required">Kunde</label><input type="text" class="form-input" name="customer" required oninput="app.updateProjectName()"></div>
                            <div class="form-group"><label class="form-label">Status</label><select class="form-select" name="status"><option value="offen">Offen</option><option value="in-arbeit">In Arbeit</option><option value="abgeschlossen">Abgeschlossen</option></select></div>
                            <div class="form-group"><label class="form-label">Ersteller</label><select class="form-select" name="creator" onchange="app.onCreatorChange(this)"><option value="">-- Bitte wählen --</option><option value="Raimon Goly|Raimon.Goly@qfm.eu|+49 151 14577 327">Raimon Goly</option><option value="_custom">Andere...</option></select><input type="text" class="form-input" name="creatorCustom" placeholder="Name eingeben" style="display:none;margin-top:8px"></div>
                            <div class="form-group full-width"><label class="form-label">Beschreibung</label><textarea class="form-textarea" name="description"></textarea></div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3 class="form-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> Projektadresse</h3>
                        <div class="form-group"><label class="form-label required">Standort</label><input type="text" class="form-input" name="location" placeholder="z.B. Berlin, Hauptstraße 42" required oninput="app.updateProjectName()"></div>
                    </div>
                    <div class="form-section">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="form-section-title" style="margin:0"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> Ansprechpartner</h3>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="app.showContactModal()">+ Hinzufügen</button>
                        </div>
                        <div class="contact-list" id="contactList"><p class="text-muted text-center">Noch keine Ansprechpartner</p></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.cancelProjectForm()">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">Speichern</button>
                    </div>
                </form>
            </div>
            <div class="view" id="projectDetailView">
                <div class="tabs">
                    <button class="tab active" data-tab="photos" onclick="app.switchTab('photos')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg> Fotos</button>
                    <button class="tab" data-tab="map" onclick="app.switchTab('map')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg> Karte</button>
                    <button class="tab" data-tab="quantities" onclick="app.switchTab('quantities')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> Mengen</button>
                </div>
                <div class="tab-content active" id="photosTab"><div class="photo-grid" id="photoGrid"></div></div>
                <div class="tab-content" id="mapTab">
                    <div class="map-container">
                        <div class="map-location-bar" id="mapLocationBar" style="padding:8px 12px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:13px">
                            <span style="color:var(--text-secondary)"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> <span id="mapLocationText">Lade...</span></span>
                            <div style="flex:1"></div>
                            <button class="btn btn-secondary btn-sm" onclick="app.reGeocodeProject()" style="font-size:11px;padding:4px 8px;min-height:32px"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Neu suchen</button>
                            <button class="btn btn-secondary btn-sm" onclick="app.useGPSForProject()" style="font-size:11px;padding:4px 8px;min-height:32px"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"/></svg> GPS</button>
                        </div>
                        <div class="map-toolbar">
                            <button class="btn btn-secondary btn-sm" onclick="app.saveMapSnapshot()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg> Karte speichern</button>
                        </div>
                        <div id="map"></div>
                    </div>
                </div>
                <div class="tab-content" id="quantitiesTab">
                    <div class="form-section">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="form-section-title" style="margin:0">Mengenaufmaß</h3>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="app.recalculateQuantities()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Berechnen</button>
                                <button class="btn btn-primary btn-sm" onclick="app.exportQuantityPDF()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> PDF</button>
                            </div>
                        </div>
                        <table class="quantity-table"><thead><tr><th>Pos.</th><th>Beschreibung</th><th>Einheit</th><th>Auto</th><th>Menge</th></tr></thead><tbody id="quantityTableBody"></tbody></table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="editor-container" id="editorContainer">
        <div class="editor-header">
            <div class="flex items-center gap-2">
                <button class="btn btn-secondary btn-sm" onclick="app.closeEditor()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Zurück</button>
                <span id="editorTitle">Bild bearbeiten</span>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-secondary btn-sm" onclick="app.editorUndo()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
                <button class="btn btn-secondary btn-sm" onclick="app.editorRedo()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>
                <button class="btn btn-danger btn-sm" onclick="app.deletePhoto()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                <button class="btn btn-primary btn-sm" onclick="app.saveEditor()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Speichern</button>
            </div>
        </div>
        <div class="editor-zoom-controls" id="editorZoomControls">
            <button onclick="app.editor.zoomIn()">+</button>
            <button onclick="app.editor.zoomOut()">−</button>
            <button onclick="app.editor.zoomReset()" style="font-size:12px">1:1</button>
        </div>
        <div class="editor-toolbar" id="editorToolbar"></div>
        <div class="trasse-props" id="trasseProps"></div>
        <div style="display:flex;flex:1;overflow:hidden">
            <div class="editor-canvas-wrapper"><canvas id="editorCanvas"></canvas></div>
            <div class="editor-sidebar">
                <div class="sidebar-title">Legende</div>
                <div id="legendList"></div>
                <div class="sidebar-title" style="margin-top:20px">Ebenen</div>
                <div id="layerList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="contactModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Ansprechpartner</h3><button class="modal-close" onclick="app.closeContactModal()">×</button></div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group"><label class="form-label required">Name</label><input type="text" class="form-input" id="contactName"></div>
                    <div class="form-group"><label class="form-label">Rolle</label><input type="text" class="form-input" id="contactRole"></div>
                    <div class="form-group"><label class="form-label">Telefon</label><input type="tel" class="form-input" id="contactPhone"></div>
                    <div class="form-group"><label class="form-label">E-Mail</label><input type="email" class="form-input" id="contactEmail"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeContactModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="app.addContact()">Hinzufügen</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="geocodeModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Adresse wählen</h3><button class="modal-close" onclick="app.closeGeocodeModal()">×</button></div>
            <div class="modal-body">
                <p class="text-muted mb-4">Mehrere Treffer gefunden:</p>
                <div class="geocode-results" id="geocodeResults"></div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <input type="file" class="file-input-hidden" id="cameraInput" accept="image/*" capture="environment" onchange="app.handlePhotoCapture(event)">
    <input type="file" class="file-input-hidden" id="importInput" accept="image/*" multiple onchange="app.handlePhotoImport(event)">
    <input type="file" class="file-input-hidden" id="jsonImportInput" accept=".json" onchange="app.handleJsonImport(event)">

    <script>
    // TOOLS DEFINITION
    const SURFACES = [
        { value: 'UNBEFESTIGT', label: 'Unbefestigt' },
        { value: 'GEHWEGPLATTE', label: 'Gehwegplatte' },
        { value: 'ASPHALT', label: 'Asphalt' },
        { value: 'BETON', label: 'Beton' },
        { value: 'PFLASTER', label: 'Pflaster' },
        { value: 'GESCHL_BAUWEISE', label: 'Geschl. Bauweise', color: '#003C71' }
    ];
    const DNS = [
        { value: 'DN50', label: 'DN50' },
        { value: 'DN100', label: 'DN100' }
    ];
    const TOOL_GROUPS = {
        SELECT: { id: 'SELECT', name: 'Auswahl', icon: '↖', type: 'utility' },
        INSTALLATIONSROHR: { id: 'INSTALLATIONSROHR', name: 'Installationsrohr', color: '#06B6D4', type: 'line', unit: 'm', lineWidth: 5, dash: [12,6] },
        TRASSE: { id: 'TRASSE', name: 'Trasse', color: '#FF0000', type: 'line', unit: 'm', lineWidth: 5 },
        SCHACHT: {
            id: 'SCHACHT', name: 'Schacht', icon: '□', type: 'group',
            children: {
                SCHACHT_AZK: {
                    id: 'SCHACHT_AZK', name: 'AZK', type: 'group',
                    children: {
                        SCHACHT_AZK_NEU: { id: 'SCHACHT_AZK_NEU', name: 'AZK Neu', color: '#DC2626', type: 'point', unit: 'Stk', symbol: '□', size: 26 },
                        SCHACHT_AZK_BESTAND: { id: 'SCHACHT_AZK_BESTAND', name: 'AZK Bestand', color: '#003C71', type: 'point', unit: 'Stk', symbol: '□', size: 26 }
                    }
                },
                SCHACHT_DAZK: {
                    id: 'SCHACHT_DAZK', name: 'DAZK', type: 'group',
                    children: {
                        SCHACHT_DAZK_NEU: { id: 'SCHACHT_DAZK_NEU', name: 'DAZK Neu', color: '#DC2626', type: 'point', unit: 'Stk', symbol: '□□', size: 26 },
                        SCHACHT_DAZK_BESTAND: { id: 'SCHACHT_DAZK_BESTAND', name: 'DAZK Bestand', color: '#003C71', type: 'point', unit: 'Stk', symbol: '□□', size: 26 }
                    }
                }
            }
        },
        MUFFE: { id: 'MUFFE', name: 'Muffe', color: '#8B5CF6', type: 'point', unit: 'Stk', symbol: '◆', size: 24 },
        BOHRUNG_HAUSEINFUEHRUNG: { id: 'BOHRUNG_HAUSEINFUEHRUNG', name: 'Bohrung HE', color: '#F59E0B', type: 'point', unit: 'Stk', symbol: '⊕', size: 28 },
        BOHRUNG_WANDDURCHFUEHRUNG: { id: 'BOHRUNG_WANDDURCHFUEHRUNG', name: 'Bohrung WD', color: '#F59E0B', type: 'point', unit: 'Stk', symbol: '⊗', size: 28 },
        HINDERNIS: { id: 'HINDERNIS', name: 'Hindernis', color: '#DC2626', type: 'point', unit: 'Stk', symbol: '⚠', size: 30 },
        PFEIL: { id: 'PFEIL', name: 'Pfeil', color: '#374151', type: 'arrow', unit: null, lineWidth: 4 },
        MASSKETTE: { id: 'MASSKETTE', name: 'Maßkette', color: '#1D4ED8', type: 'dimension', unit: null, lineWidth: 2 },
        TEXT_CALL_OUT: { id: 'TEXT_CALL_OUT', name: 'Text', color: '#1A1A2E', type: 'text' }
    };

    
    // Flatten tools for lookup
    const TOOLS = {};
    function flattenTools(obj, parent = null) {
        Object.values(obj).forEach(tool => {
            if (tool.type !== 'group') {
                TOOLS[tool.id] = tool;
            }
            if (tool.children) {
                flattenTools(tool.children, tool);
            }
        });
    }
    flattenTools(TOOL_GROUPS);

    // DATABASE (IndexedDB with LocalStorage fallback)
    class Database {
        constructor() { this.db = null; this.useIDB = true; }
        async init() {
            return new Promise((resolve) => {
                if (!window.indexedDB) { this.useIDB = false; resolve(); return; }
                const req = indexedDB.open('SiteSketchDB', 1);
                req.onerror = () => { this.useIDB = false; resolve(); };
                req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('projects')) {
                        const ps = db.createObjectStore('projects', { keyPath: 'id' });
                        ps.createIndex('customer', 'customer');
                    }
                    if (!db.objectStoreNames.contains('photos')) {
                        const phs = db.createObjectStore('photos', { keyPath: 'id' });
                        phs.createIndex('projectId', 'projectId');
                    }
                };
            });
        }
        async getAll(store) {
            if (!this.useIDB) return JSON.parse(localStorage.getItem('ss_' + store) || '[]');
            return new Promise((resolve) => {
                const tx = this.db.transaction([store], 'readonly');
                tx.objectStore(store).getAll().onsuccess = (e) => resolve(e.target.result);
            });
        }
        async get(store, id) {
            if (!this.useIDB) return (await this.getAll(store)).find(i => i.id === id);
            return new Promise((resolve) => {
                const tx = this.db.transaction([store], 'readonly');
                tx.objectStore(store).get(id).onsuccess = (e) => resolve(e.target.result);
            });
        }
        async put(store, item) {
            if (!this.useIDB) {
                const items = await this.getAll(store);
                const idx = items.findIndex(i => i.id === item.id);
                if (idx >= 0) items[idx] = item; else items.push(item);
                localStorage.setItem('ss_' + store, JSON.stringify(items));
                return item;
            }
            return new Promise((resolve) => {
                const tx = this.db.transaction([store], 'readwrite');
                tx.objectStore(store).put(item).onsuccess = () => resolve(item);
            });
        }
        async delete(store, id) {
            if (!this.useIDB) {
                const items = (await this.getAll(store)).filter(i => i.id !== id);
                localStorage.setItem('ss_' + store, JSON.stringify(items));
                return;
            }
            return new Promise((resolve) => {
                const tx = this.db.transaction([store], 'readwrite');
                tx.objectStore(store).delete(id).onsuccess = () => resolve();
            });
        }
        async getByIndex(store, index, value) {
            if (!this.useIDB) return (await this.getAll(store)).filter(i => i[index] === value);
            return new Promise((resolve) => {
                const tx = this.db.transaction([store], 'readonly');
                tx.objectStore(store).index(index).getAll(value).onsuccess = (e) => resolve(e.target.result);
            });
        }
    }

    // GEOCODING SERVICE
    // iOS Detection & Utilities
    const iOS = {
        isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1),
        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
        nextFrame: () => new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r))),
        forceLayout: (el) => { el.offsetHeight; return el; },
        getViewportHeight: () => window.visualViewport ? window.visualViewport.height : window.innerHeight
    };

    // EDITOR
    class Editor {
        constructor() { 
            this.canvas = null; this.ctx = null; this.photo = null; this.image = null; 
            this.annotations = []; this.selectedTool = 'SELECT'; this.selectedAnn = null; 
            this.undoStack = []; this.redoStack = []; this.drawing = false; this.path = []; 
            this.scale = 1; this.currentMousePos = null;
            this.dragPointIndex = null; // For dragging individual points in SELECT mode
            this.currentSurface = 'GEHWEGPLATTE';
            this.currentDN = 'DN50';
            this.sizeMultiplier = 1; // Größen-Multiplikator für Werkzeuge
        }
        init(photo, img) {
            this.photo = photo; this.image = img; this.annotations = JSON.parse(JSON.stringify(photo.annotations || []));
            this.undoStack = []; this.redoStack = []; this.selectedAnn = null; this.selectedTool = 'SELECT';
            this.dragPointIndex = null;
            this.canvas = document.getElementById('editorCanvas'); this.ctx = this.canvas.getContext('2d');
            // Canvas sizing - iOS aware with visualViewport
            const toolbarReserve = iOS.isIOS ? 120 : 100;
            const headerReserve = iOS.isIOS ? 120 : 100;
            const margin = 32;
            const maxW = Math.max(200, window.innerWidth - margin);
            const maxH = Math.max(200, iOS.getViewportHeight() - (toolbarReserve + headerReserve));
            this.scale = Math.min(maxW / img.width, maxH / img.height, 1);
            this.canvas.width = img.width * this.scale; this.canvas.height = img.height * this.scale;
            this.setupEvents(); this.renderToolbar(); this.renderLegend(); this.renderLayers(); this.render();
        }
        setupEvents() {
            const getP = (e) => { const r = this.canvas.getBoundingClientRect(); return { x: (e.clientX - r.left) / this.scale, y: (e.clientY - r.top) / this.scale }; };
            
            this.canvas.onmousedown = (e) => {
                const p = getP(e), tool = TOOLS[this.selectedTool];
                
                if (this.selectedTool === 'SELECT') { 
                    // First check if clicking on a point of the selected annotation (for individual point dragging)
                    if (this.selectedAnn && this.selectedAnn.points) {
                        const pointIdx = this.findPointAt(p, this.selectedAnn);
                        if (pointIdx !== null) {
                            this.dragPointIndex = pointIdx;
                            this.selectedAnn._dragPoint = {...p};
                            this.saveState();
                            return;
                        }
                    }
                    // Otherwise try to select an annotation
                    this.selectedAnn = this.findAt(p); 
                    if (this.selectedAnn && this.selectedAnn.tool === 'TRASSE') this.ensureTrasseMeta(this.selectedAnn);
                    if (this.selectedAnn) this.selectedAnn._drag = {...p}; 
                    this.dragPointIndex = null;
                    this.renderLayers(); 
                    this.render(); 
                    this.updateTrasseProps();
                }
                else if (tool.type === 'line' || tool.type === 'arrow' || tool.type === 'dimension') { 
                    // Drag-to-draw: start a new line on mousedown
                    this.drawing = true;
                    this.path = [p];
                    this.saveState();
                    this.render();
                }
                else if (tool.type === 'point') { 
                    this.saveState(); 
                    this.annotations.push({ id: 'a'+Date.now(), tool: this.selectedTool, point: p }); 
                    this.renderLayers(); 
                    this.render(); 
                }
                else if (tool.type === 'text') { 
                    const t = prompt('Text:'); 
                    if (t) { 
                        this.saveState(); 
                        this.annotations.push({ id: 'a'+Date.now(), tool: this.selectedTool, point: p, text: t }); 
                        this.renderLayers(); 
                        this.render(); 
                    } 
                }
            };
            
            this.canvas.onmousemove = (e) => {
                const p = getP(e);
                this.currentMousePos = p;
                
                // Dragging individual point in SELECT mode
                if (this.selectedTool === 'SELECT' && this.selectedAnn && this.dragPointIndex !== null && this.selectedAnn._dragPoint) {
                    this.selectedAnn.points[this.dragPointIndex].x = p.x;
                    this.selectedAnn.points[this.dragPointIndex].y = p.y;
                    // Recalculate length if map snapshot
                    if (this.photo.isMapSnapshot && this.photo.mapMetadata) {
                        this.selectedAnn.computed = { lengthMeters: this.calcLength(this.selectedAnn.points) };
                    }
                    this.render();
                    return;
                }
                
                // Dragging whole annotation in SELECT mode
                if (this.selectedAnn && this.selectedAnn._drag) {
                    const dx = p.x - this.selectedAnn._drag.x, dy = p.y - this.selectedAnn._drag.y;
                    if (this.selectedAnn.points) this.selectedAnn.points = this.selectedAnn.points.map(pt => ({x:pt.x+dx,y:pt.y+dy}));
                    else if (this.selectedAnn.point) { this.selectedAnn.point.x += dx; this.selectedAnn.point.y += dy; }
                    this.selectedAnn._drag = {...p};
                }
                
                this.render();
            };
            
            this.canvas.onmouseup = (e) => {
                const p = getP(e);
                
                // Finish dragging individual point
                if (this.dragPointIndex !== null && this.selectedAnn && this.selectedAnn._dragPoint) {
                    delete this.selectedAnn._dragPoint;
                    this.dragPointIndex = null;
                    this.renderLayers();
                    return;
                }
                
                // Finish dragging whole annotation
                if (this.selectedAnn && this.selectedAnn._drag) { 
                    delete this.selectedAnn._drag; 
                    this.saveState(); 
                }
                
                // Finish drawing line (drag-to-draw: complete line on mouseup)
                if (this.drawing && this.path.length > 0) {
                    const tool = TOOLS[this.selectedTool];
                    if (tool && (tool.type === 'line' || tool.type === 'arrow' || tool.type === 'dimension')) {
                        // Add end point
                        this.path.push(p);
                        
                        // Create annotation with 2 points (start and end)
                        const ann = { id: 'a'+Date.now(), tool: this.selectedTool, points: this.path };
                        if (ann.tool === 'TRASSE') {
                            ann.meta = { surface: this.currentSurface, dn: this.currentDN };
                        }
                        if (this.photo.isMapSnapshot && this.photo.mapMetadata) {
                            ann.computed = { lengthMeters: this.calcLength(this.path) };
                        }
                        // Bei Maßkette: Text abfragen
                        if (tool.type === 'dimension') {
                            const measure = prompt('Maß eingeben (z.B. 2.5 m):');
                            ann.text = measure || '? m';
                        }
                        this.annotations.push(ann);
                        this.renderLayers();
                    }
                    this.drawing = false;
                    this.path = [];
                    this.currentMousePos = null;
                    this.render();
                }
            };
            
            this.canvas.ondblclick = (e) => {
                // Double click to edit text (no longer needed for lines)
                if (this.selectedTool === 'SELECT' && this.selectedAnn && this.selectedAnn.text !== undefined) {
                    const t = prompt('Text:', this.selectedAnn.text);
                    if (t !== null) { this.saveState(); this.selectedAnn.text = t; this.render(); }
                }
            };
            
            // Touch events - iOS optimized with passive:false
            // Double-tap-drag zoom state
            let lastTapTime = 0;
            let isZoomDragging = false;
            let zoomStartY = 0;
            let zoomStartScale = 1;
            
            const handleTouchStart = (e) => { 
                const now = Date.now();
                const timeSinceLastTap = now - lastTapTime;
                
                // Detect double-tap (second tap within 300ms)
                if (timeSinceLastTap < 300 && e.touches.length === 1) {
                    // Start zoom drag mode
                    isZoomDragging = true;
                    zoomStartY = e.touches[0].clientY;
                    zoomStartScale = this.scale;
                    e.preventDefault();
                    return;
                }
                
                lastTapTime = now;
                
                // Normal touch handling
                if (isZoomDragging) return;
                
                e.preventDefault(); 
                const t = e.touches[0];
                const r = this.canvas.getBoundingClientRect();
                const p = { x: (t.clientX - r.left) / this.scale, y: (t.clientY - r.top) / this.scale };
                const tool = TOOLS[this.selectedTool];
                
                if (this.selectedTool === 'SELECT') { 
                    if (this.selectedAnn && this.selectedAnn.points) {
                        const pointIdx = this.findPointAt(p, this.selectedAnn);
                        if (pointIdx !== null) {
                            this.dragPointIndex = pointIdx;
                            this.selectedAnn._dragPoint = {...p};
                            this.saveState();
                            return;
                        }
                    }
                    this.selectedAnn = this.findAt(p); 
                    if (this.selectedAnn && this.selectedAnn.tool === 'TRASSE') this.ensureTrasseMeta(this.selectedAnn);
                    if (this.selectedAnn) this.selectedAnn._drag = {...p}; 
                    this.dragPointIndex = null;
                    this.renderLayers(); 
                    this.render(); 
                    this.updateTrasseProps();
                }
                else if (tool && (tool.type === 'line' || tool.type === 'arrow' || tool.type === 'dimension')) { 
                    this.drawing = true;
                    this.path = [p];
                    this.saveState();
                    this.render();
                }
                else if (tool && tool.type === 'point') { 
                    this.saveState(); 
                    this.annotations.push({ id: 'a'+Date.now(), tool: this.selectedTool, point: p }); 
                    this.renderLayers(); 
                    this.render(); 
                }
                else if (tool && tool.type === 'text') { 
                    const txt = prompt('Text:'); 
                    if (txt) { 
                        this.saveState(); 
                        this.annotations.push({ id: 'a'+Date.now(), tool: this.selectedTool, point: p, text: txt }); 
                        this.renderLayers(); 
                        this.render(); 
                    } 
                }
            };
            
            const handleTouchMove = (e) => { 
                // Handle zoom drag
                if (isZoomDragging && e.touches.length === 1) {
                    e.preventDefault();
                    const currentY = e.touches[0].clientY;
                    const deltaY = zoomStartY - currentY; // Negative = finger moved down, Positive = finger moved up
                    const zoomFactor = 1 + (deltaY / 200); // 200px drag = 2x zoom change
                    const newScale = Math.max(0.2, Math.min(3, zoomStartScale * zoomFactor));
                    this.scale = newScale;
                    this.applyZoom();
                    return;
                }
                
                e.preventDefault(); 
                const t = e.touches[0];
                const r = this.canvas.getBoundingClientRect();
                const p = { x: (t.clientX - r.left) / this.scale, y: (t.clientY - r.top) / this.scale };
                this.currentMousePos = p;
                
                if (this.selectedTool === 'SELECT' && this.selectedAnn && this.dragPointIndex !== null && this.selectedAnn._dragPoint) {
                    this.selectedAnn.points[this.dragPointIndex].x = p.x;
                    this.selectedAnn.points[this.dragPointIndex].y = p.y;
                    if (this.photo.isMapSnapshot && this.photo.mapMetadata) {
                        this.selectedAnn.computed = { lengthMeters: this.calcLength(this.selectedAnn.points) };
                    }
                    this.render();
                    return;
                }
                
                if (this.selectedAnn && this.selectedAnn._drag) {
                    const dx = p.x - this.selectedAnn._drag.x, dy = p.y - this.selectedAnn._drag.y;
                    if (this.selectedAnn.points) this.selectedAnn.points = this.selectedAnn.points.map(pt => ({x:pt.x+dx,y:pt.y+dy}));
                    else if (this.selectedAnn.point) { this.selectedAnn.point.x += dx; this.selectedAnn.point.y += dy; }
                    this.selectedAnn._drag = {...p};
                }
                
                this.render();
            };
            
            const handleTouchEnd = (e) => { 
                // End zoom drag
                if (isZoomDragging) {
                    isZoomDragging = false;
                    return;
                }
                
                e.preventDefault();
                const lastP = this.currentMousePos;
                
                if (this.dragPointIndex !== null && this.selectedAnn && this.selectedAnn._dragPoint) {
                    delete this.selectedAnn._dragPoint;
                    this.dragPointIndex = null;
                    this.renderLayers();
                    return;
                }
                
                if (this.selectedAnn && this.selectedAnn._drag) { 
                    delete this.selectedAnn._drag; 
                    this.saveState(); 
                }
                
                if (this.drawing && this.path.length > 0 && lastP) {
                    const tool = TOOLS[this.selectedTool];
                    if (tool && (tool.type === 'line' || tool.type === 'arrow' || tool.type === 'dimension')) {
                        this.path.push(lastP);
                        const ann = { id: 'a'+Date.now(), tool: this.selectedTool, points: this.path };
                        if (ann.tool === 'TRASSE') {
                            ann.meta = { surface: this.currentSurface, dn: this.currentDN };
                        }
                        if (this.photo.isMapSnapshot && this.photo.mapMetadata) {
                            ann.computed = { lengthMeters: this.calcLength(this.path) };
                        }
                        // Bei Maßkette: Text abfragen
                        if (tool.type === 'dimension') {
                            const measure = prompt('Maß eingeben (z.B. 2.5 m):');
                            ann.text = measure || '? m';
                        }
                        this.annotations.push(ann);
                        this.renderLayers();
                    }
                    this.drawing = false;
                    this.path = [];
                    this.currentMousePos = null;
                    this.render();
                }
            };
            
            // iOS: Must use passive: false to allow preventDefault
            this.canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            this.canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            this.canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            this.canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });
        }
        
        findPointAt(p, ann) {
            if (!ann.points) return null;
            for (let i = 0; i < ann.points.length; i++) {
                if (Math.hypot(p.x - ann.points[i].x, p.y - ann.points[i].y) < 15) {
                    return i;
                }
            }
            return null;
        }
        findAt(p) {
            for (let i = this.annotations.length - 1; i >= 0; i--) {
                const a = this.annotations[i];
                if (a.points) { for (let j = 0; j < a.points.length - 1; j++) if (this.distSeg(p, a.points[j], a.points[j+1]) < 10) return a; }
                else if (a.point && Math.hypot(p.x - a.point.x, p.y - a.point.y) < 20) return a;
            }
            return null;
        }
        distSeg(p, a, b) { const dx = b.x - a.x, dy = b.y - a.y, t = Math.max(0, Math.min(1, ((p.x-a.x)*dx + (p.y-a.y)*dy) / (dx*dx+dy*dy||1))); return Math.hypot(p.x - (a.x+t*dx), p.y - (a.y+t*dy)); }
        calcLength(pts) {
            if (!this.photo.mapMetadata) return 0;
            const m = this.photo.mapMetadata, bb = m.boundingBox; let total = 0;
            for (let i = 0; i < pts.length - 1; i++) {
                const p1 = { lon: bb.west + pts[i].x * (bb.east-bb.west)/m.pixelWidth, lat: bb.north - pts[i].y * (bb.north-bb.south)/m.pixelHeight };
                const p2 = { lon: bb.west + pts[i+1].x * (bb.east-bb.west)/m.pixelWidth, lat: bb.north - pts[i+1].y * (bb.north-bb.south)/m.pixelHeight };
                const R = 6371000, dLat = (p2.lat-p1.lat)*Math.PI/180, dLon = (p2.lon-p1.lon)*Math.PI/180;
                const aa = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
                total += R * 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
            }
            return total;
        }
        saveState() { this.undoStack.push(JSON.stringify(this.annotations)); this.redoStack = []; if (this.undoStack.length > 50) this.undoStack.shift(); }
        undo() { if (!this.undoStack.length) return; this.redoStack.push(JSON.stringify(this.annotations)); this.annotations = JSON.parse(this.undoStack.pop()); this.selectedAnn = null; this.renderLayers(); this.render(); }
        redo() { if (!this.redoStack.length) return; this.undoStack.push(JSON.stringify(this.annotations)); this.annotations = JSON.parse(this.redoStack.pop()); this.selectedAnn = null; this.renderLayers(); this.render(); }
        deleteSelected() { if (!this.selectedAnn) return; this.saveState(); this.annotations = this.annotations.filter(a => a.id !== this.selectedAnn.id); this.selectedAnn = null; this.renderLayers(); this.render(); }
        render() {
            if (!this.ctx) return;
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.drawImage(this.image, 0, 0, this.canvas.width, this.canvas.height);
            this.annotations.forEach(a => this.drawAnn(a, a === this.selectedAnn));
            // Draw preview line while drawing (single straight line from start to current position)
            if (this.drawing && this.path.length > 0 && this.currentMousePos) {
                const tool = TOOLS[this.selectedTool];
                this.ctx.save();
                this.ctx.strokeStyle = tool.color;
                this.ctx.lineWidth = (tool.lineWidth || 2) * this.scale;
                if (tool.dash) this.ctx.setLineDash(tool.dash.map(d => d*this.scale)); else this.ctx.setLineDash([]);
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.globalAlpha = 0.6;
                this.ctx.beginPath();
                this.ctx.moveTo(this.path[0].x * this.scale, this.path[0].y * this.scale);
                this.ctx.lineTo(this.currentMousePos.x * this.scale, this.currentMousePos.y * this.scale);
                this.ctx.stroke();
                // Draw start point
                this.ctx.globalAlpha = 1;
                this.ctx.fillStyle = '#FFF';
                this.ctx.strokeStyle = tool.color;
                this.ctx.lineWidth = 2;
                this.ctx.setLineDash([]);
                this.ctx.beginPath();
                this.ctx.arc(this.path[0].x * this.scale, this.path[0].y * this.scale, 6, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.stroke();
                this.ctx.restore();
            }
        }
        drawAnn(a, sel) {
            const tool = TOOLS[a.tool]; if (!tool) return;
            this.ctx.save();
            if (tool.type === 'line' && a.points && a.points.length > 1) {
                // Bei Trasse: Farbe aus Oberfläche nehmen
                let lineColor = tool.color;
                if (a.tool === 'TRASSE' && a.meta?.surface) {
                    const surf = SURFACES.find(s => s.value === a.meta.surface);
                    if (surf?.color) lineColor = surf.color;
                }
                
                this.ctx.strokeStyle = lineColor; this.ctx.lineWidth = (tool.lineWidth + (sel?2:0)) * this.scale * this.sizeMultiplier; this.ctx.lineCap = 'round';
                if (tool.dash) this.ctx.setLineDash(tool.dash.map(d => d*this.scale)); else this.ctx.setLineDash([]);
                this.ctx.beginPath(); this.ctx.moveTo(a.points[0].x * this.scale, a.points[0].y * this.scale);
                for (let i = 1; i < a.points.length; i++) this.ctx.lineTo(a.points[i].x * this.scale, a.points[i].y * this.scale);
                this.ctx.stroke();
                if (a.computed && a.computed.lengthMeters) {
                    // Berechne die echte Mitte der Linie
                    let totalLen = 0, segments = [];
                    for (let i = 1; i < a.points.length; i++) {
                        const dx = a.points[i].x - a.points[i-1].x, dy = a.points[i].y - a.points[i-1].y;
                        const segLen = Math.sqrt(dx*dx + dy*dy);
                        segments.push({ start: a.points[i-1], end: a.points[i], len: segLen });
                        totalLen += segLen;
                    }
                    const halfLen = totalLen / 2;
                    let accumulated = 0, mid = a.points[0];
                    for (const seg of segments) {
                        if (accumulated + seg.len >= halfLen) {
                            const ratio = (halfLen - accumulated) / seg.len;
                            mid = { x: seg.start.x + (seg.end.x - seg.start.x) * ratio, y: seg.start.y + (seg.end.y - seg.start.y) * ratio };
                            break;
                        }
                        accumulated += seg.len;
                    }
                    
                    // Label erstellen - bei Trasse mit DN und Oberfläche
                    let label = tool.name;
                    if (a.tool === 'TRASSE' && a.meta) {
                        const dn = a.meta.dn || 'DN50';
                        const surfObj = SURFACES.find(s => s.value === (a.meta.surface || 'GEHWEGPLATTE'));
                        const surfLabel = surfObj ? surfObj.label : a.meta.surface;
                        label = `${dn} · ${surfLabel}`;
                    }
                    label += ' · ' + a.computed.lengthMeters.toFixed(1) + ' m';
                    
                    this.ctx.font = `bold ${10*this.scale}px 'Roboto', sans-serif`; const tw = this.ctx.measureText(label).width;
                    this.ctx.fillStyle = 'rgba(255,255,255,0.92)'; 
                    this.ctx.strokeStyle = lineColor; this.ctx.lineWidth = 1.5;
                    const boxH = 18*this.scale, boxY = mid.y*this.scale - boxH/2;
                    this.ctx.beginPath(); this.ctx.roundRect(mid.x*this.scale - tw/2 - 6, boxY, tw + 12, boxH, 4*this.scale); this.ctx.fill(); this.ctx.stroke();
                    this.ctx.fillStyle = lineColor; this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(label, mid.x * this.scale, mid.y * this.scale);
                }
                if (sel) a.points.forEach(p => { this.ctx.fillStyle = '#FFF'; this.ctx.strokeStyle = lineColor; this.ctx.lineWidth = 2; this.ctx.setLineDash([]); this.ctx.beginPath(); this.ctx.arc(p.x*this.scale, p.y*this.scale, 8, 0, Math.PI*2); this.ctx.fill(); this.ctx.stroke(); });
            } else if (tool.type === 'point' && a.point) {
                const x = a.point.x * this.scale, y = a.point.y * this.scale;
                const baseSize = tool.size || 14;
                const sz = (sel ? baseSize + 4 : baseSize) * this.scale * this.sizeMultiplier;
                this.ctx.fillStyle = tool.color; this.ctx.strokeStyle = '#FFF'; this.ctx.lineWidth = 3 * this.scale * this.sizeMultiplier;
                if (tool.symbol === '○') { this.ctx.beginPath(); this.ctx.arc(x, y, sz/2, 0, Math.PI*2); this.ctx.fill(); this.ctx.stroke(); }
                else if (tool.symbol === '□□') { 
                    // Doppel-Rechteck für DAZK
                    const gap = 4 * this.scale * this.sizeMultiplier;
                    this.ctx.fillRect(x - sz/2 - gap/2, y - sz/2, sz * 0.45, sz); 
                    this.ctx.strokeRect(x - sz/2 - gap/2, y - sz/2, sz * 0.45, sz);
                    this.ctx.fillRect(x + gap/2, y - sz/2, sz * 0.45, sz); 
                    this.ctx.strokeRect(x + gap/2, y - sz/2, sz * 0.45, sz);
                }
                else if (tool.symbol === '□') { this.ctx.fillRect(x-sz/2, y-sz/2, sz, sz); this.ctx.strokeRect(x-sz/2, y-sz/2, sz, sz); }
                else if (tool.symbol === '◆') { 
                    // Raute für Muffe
                    this.ctx.beginPath(); 
                    this.ctx.moveTo(x, y - sz/2); 
                    this.ctx.lineTo(x + sz/2, y); 
                    this.ctx.lineTo(x, y + sz/2); 
                    this.ctx.lineTo(x - sz/2, y); 
                    this.ctx.closePath(); 
                    this.ctx.fill(); this.ctx.stroke(); 
                }
                else if (tool.symbol === '⚠') { 
                    // Dreieck für Hindernis/Warnung
                    this.ctx.beginPath(); 
                    this.ctx.moveTo(x, y - sz/2); 
                    this.ctx.lineTo(x + sz/2, y + sz/2); 
                    this.ctx.lineTo(x - sz/2, y + sz/2); 
                    this.ctx.closePath(); 
                    this.ctx.fill(); this.ctx.stroke();
                    // Ausrufezeichen
                    this.ctx.fillStyle = '#FFF';
                    this.ctx.font = `bold ${sz*0.5}px sans-serif`;
                    this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle';
                    this.ctx.fillText('!', x, y + sz*0.15);
                }
                else { this.ctx.beginPath(); this.ctx.arc(x, y, sz/2, 0, Math.PI*2); this.ctx.fill(); this.ctx.stroke(); this.ctx.strokeStyle = '#FFF'; this.ctx.beginPath(); this.ctx.moveTo(x-sz/3,y); this.ctx.lineTo(x+sz/3,y); this.ctx.moveTo(x,y-sz/3); this.ctx.lineTo(x,y+sz/3); this.ctx.stroke(); }
            } else if (tool.type === 'arrow' && a.points && a.points.length >= 2) {
                // Pfeil zeichnen
                const p1 = a.points[0], p2 = a.points[a.points.length - 1];
                const x1 = p1.x * this.scale, y1 = p1.y * this.scale;
                const x2 = p2.x * this.scale, y2 = p2.y * this.scale;
                const angle = Math.atan2(y2 - y1, x2 - x1);
                const headLen = 20 * this.scale * this.sizeMultiplier;
                
                this.ctx.strokeStyle = tool.color; 
                this.ctx.fillStyle = tool.color;
                this.ctx.lineWidth = (tool.lineWidth + (sel ? 2 : 0)) * this.scale * this.sizeMultiplier; 
                this.ctx.lineCap = 'round';
                
                // Linie
                this.ctx.beginPath();
                this.ctx.moveTo(x1, y1);
                this.ctx.lineTo(x2, y2);
                this.ctx.stroke();
                
                // Pfeilspitze
                this.ctx.beginPath();
                this.ctx.moveTo(x2, y2);
                this.ctx.lineTo(x2 - headLen * Math.cos(angle - Math.PI/6), y2 - headLen * Math.sin(angle - Math.PI/6));
                this.ctx.lineTo(x2 - headLen * Math.cos(angle + Math.PI/6), y2 - headLen * Math.sin(angle + Math.PI/6));
                this.ctx.closePath();
                this.ctx.fill();
                
                if (sel) {
                    this.ctx.fillStyle = '#FFF'; this.ctx.strokeStyle = tool.color; this.ctx.lineWidth = 2;
                    [p1, p2].forEach(p => { this.ctx.beginPath(); this.ctx.arc(p.x*this.scale, p.y*this.scale, 8, 0, Math.PI*2); this.ctx.fill(); this.ctx.stroke(); });
                }
            } else if (tool.type === 'dimension' && a.points && a.points.length >= 2) {
                // Maßkette zeichnen
                const p1 = a.points[0], p2 = a.points[a.points.length - 1];
                const x1 = p1.x * this.scale, y1 = p1.y * this.scale;
                const x2 = p2.x * this.scale, y2 = p2.y * this.scale;
                const tickLen = 10 * this.scale * this.sizeMultiplier;
                const angle = Math.atan2(y2 - y1, x2 - x1);
                const perpAngle = angle + Math.PI/2;
                
                this.ctx.strokeStyle = tool.color; 
                this.ctx.lineWidth = (tool.lineWidth + (sel ? 1 : 0)) * this.scale * this.sizeMultiplier; 
                this.ctx.lineCap = 'round';
                
                // Hauptlinie
                this.ctx.beginPath();
                this.ctx.moveTo(x1, y1);
                this.ctx.lineTo(x2, y2);
                this.ctx.stroke();
                
                // Endstriche
                this.ctx.beginPath();
                this.ctx.moveTo(x1 + tickLen * Math.cos(perpAngle), y1 + tickLen * Math.sin(perpAngle));
                this.ctx.lineTo(x1 - tickLen * Math.cos(perpAngle), y1 - tickLen * Math.sin(perpAngle));
                this.ctx.moveTo(x2 + tickLen * Math.cos(perpAngle), y2 + tickLen * Math.sin(perpAngle));
                this.ctx.lineTo(x2 - tickLen * Math.cos(perpAngle), y2 - tickLen * Math.sin(perpAngle));
                this.ctx.stroke();
                
                // Maß-Text
                const midX = (x1 + x2) / 2, midY = (y1 + y2) / 2;
                const label = a.text || '? m';
                this.ctx.font = `bold ${12*this.scale}px 'Roboto', sans-serif`;
                const tw = this.ctx.measureText(label).width;
                this.ctx.fillStyle = 'rgba(255,255,255,0.95)';
                this.ctx.fillRect(midX - tw/2 - 4, midY - 10*this.scale, tw + 8, 20*this.scale);
                this.ctx.fillStyle = tool.color;
                this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle';
                this.ctx.fillText(label, midX, midY);
                
                if (sel) {
                    this.ctx.fillStyle = '#FFF'; this.ctx.strokeStyle = tool.color; this.ctx.lineWidth = 2;
                    [p1, p2].forEach(p => { this.ctx.beginPath(); this.ctx.arc(p.x*this.scale, p.y*this.scale, 8, 0, Math.PI*2); this.ctx.fill(); this.ctx.stroke(); });
                }
            } else if (tool.type === 'text' && a.point && a.text) {
                const x = a.point.x * this.scale, y = a.point.y * this.scale;
                this.ctx.font = `${14*this.scale}px sans-serif`; const tw = this.ctx.measureText(a.text).width, pad = 6*this.scale, bh = 20*this.scale;
                this.ctx.fillStyle = sel ? '#FEF3C7' : '#FFFBEB'; this.ctx.strokeStyle = sel ? '#F59E0B' : '#FCD34D'; this.ctx.lineWidth = 1;
                this.ctx.beginPath(); this.ctx.roundRect(x, y-bh/2, tw+pad*2, bh, 4); this.ctx.fill(); this.ctx.stroke();
                this.ctx.fillStyle = '#1A1A2E'; this.ctx.textAlign = 'left'; this.ctx.textBaseline = 'middle'; this.ctx.fillText(a.text, x+pad, y);
            }
            this.ctx.restore();
        }
        
        closeFlyout() {
            const existing = document.querySelector('.tool-flyout');
            if (existing) existing.remove();
        }
        
        showFlyout(btn, content, title) {
            this.closeFlyout();
            const flyout = document.createElement('div');
            flyout.className = 'tool-flyout';
            
            const rect = btn.getBoundingClientRect();
            flyout.style.top = Math.min(rect.top, window.innerHeight - 300) + 'px';
            
            if (title) {
                const titleEl = document.createElement('div');
                titleEl.className = 'tool-flyout-title';
                titleEl.textContent = title;
                flyout.appendChild(titleEl);
            }
            
            flyout.appendChild(content);
            document.body.appendChild(flyout);
            
            // Close on outside click
            setTimeout(() => {
                const closeHandler = (e) => {
                    if (!flyout.contains(e.target) && !btn.contains(e.target)) {
                        flyout.remove();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                document.addEventListener('click', closeHandler);
            }, 10);
        }
        
        renderToolbar() {
            const tb = document.getElementById('editorToolbar'); 
            tb.innerHTML = '';
            
            // Tool-Icons mit Flyouts
            const toolGroups = [
                { id: 'SELECT', icon: '↖', name: 'Auswahl' },
                { id: 'LINES', icon: '━', name: 'Linien', children: ['TRASSE', 'INSTALLATIONSROHR', 'PFEIL', 'MASSKETTE'] },
                { id: 'POINTS', icon: '●', name: 'Punkte', children: ['MUFFE', 'BOHRUNG_HAUSEINFUEHRUNG', 'BOHRUNG_WANDDURCHFUEHRUNG', 'HINDERNIS'] },
                { id: 'SCHACHT_GROUP', icon: '□', name: 'Schächte', children: ['SCHACHT_AZK_NEU', 'SCHACHT_AZK_BESTAND', 'SCHACHT_DAZK_NEU', 'SCHACHT_DAZK_BESTAND'] },
                { id: 'TEXT_CALL_OUT', icon: 'T', name: 'Text' },
                { id: 'SETTINGS', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>', name: 'Einstellungen', isSettings: true },
            ];
            
            const isToolInGroup = (toolId, groupChildren) => groupChildren && groupChildren.includes(toolId);
            const getActiveGroupForTool = () => {
                for (const g of toolGroups) {
                    if (g.children && g.children.includes(this.selectedTool)) return g.id;
                }
                return null;
            };
            
            toolGroups.forEach(group => {
                const btn = document.createElement('button');
                const isActive = this.selectedTool === group.id || 
                    (group.children && group.children.includes(this.selectedTool));
                btn.className = 'tool-btn' + (isActive ? ' active' : '');
                
                // Zeige Farbe des aktiven Tools wenn in Gruppe
                if (group.children && group.children.includes(this.selectedTool)) {
                    const activeTool = TOOLS[this.selectedTool];
                    if (activeTool?.color) {
                        btn.innerHTML = `<span class="tool-color" style="background:${activeTool.color}"></span>`;
                    } else {
                        btn.innerHTML = group.icon;
                    }
                } else {
                    btn.innerHTML = group.icon;
                }
                
                btn.onclick = (e) => {
                    e.stopPropagation();
                    
                    if (group.isSettings) {
                        // Settings Flyout
                        const content = document.createElement('div');
                        content.className = 'toolbar-settings';
                        content.innerHTML = `
                            <div class="toolbar-setting-row">
                                <label>Oberfläche</label>
                                <select id="flyoutSurface">
                                    ${SURFACES.map(s => `<option value="${s.value}" ${this.currentSurface===s.value?'selected':''}>${s.label}</option>`).join('')}
                                </select>
                            </div>
                            <div class="toolbar-setting-row">
                                <label>DN</label>
                                <select id="flyoutDN">
                                    ${DNS.map(d => `<option value="${d.value}" ${this.currentDN===d.value?'selected':''}>${d.label}</option>`).join('')}
                                </select>
                            </div>
                            <div class="toolbar-setting-row">
                                <label>Größe: ${this.sizeMultiplier}x</label>
                                <input type="range" id="flyoutSize" min="0.5" max="4" step="0.25" value="${this.sizeMultiplier}">
                            </div>
                        `;
                        this.showFlyout(btn, content, 'Einstellungen');
                        
                        content.querySelector('#flyoutSurface').onchange = (e) => { this.currentSurface = e.target.value; };
                        content.querySelector('#flyoutDN').onchange = (e) => { this.currentDN = e.target.value; };
                        content.querySelector('#flyoutSize').oninput = (e) => { 
                            this.sizeMultiplier = parseFloat(e.target.value); 
                            e.target.previousElementSibling.textContent = `Größe: ${this.sizeMultiplier}x`;
                            this.render(); 
                        };
                    } else if (group.children) {
                        // Group Flyout
                        const content = document.createElement('div');
                        group.children.forEach(toolId => {
                            const tool = TOOLS[toolId];
                            if (!tool) return;
                            const item = document.createElement('div');
                            item.className = 'tool-flyout-item' + (this.selectedTool === toolId ? ' active' : '');
                            item.innerHTML = tool.color 
                                ? `<span class="flyout-color" style="background:${tool.color}"></span><span>${tool.name}</span>`
                                : `<span class="flyout-icon">${tool.icon || '•'}</span><span>${tool.name}</span>`;
                            item.onclick = () => {
                                this.selectedTool = toolId;
                                this.selectedAnn = null;
                                this.closeFlyout();
                                this.renderToolbar();
                                this.render();
                            };
                            content.appendChild(item);
                        });
                        this.showFlyout(btn, content, group.name);
                    } else {
                        // Direct tool selection
                        this.selectedTool = group.id;
                        this.selectedAnn = null;
                        this.closeFlyout();
                        this.renderToolbar();
                        this.render();
                    }
                };
                
                tb.appendChild(btn);
            });
            
            // Separator
            const sep = document.createElement('div');
            sep.style.cssText = 'height:1px;background:var(--border);margin:4px 0;';
            tb.appendChild(sep);
            
            // Delete Button (wenn etwas ausgewählt)
            if (this.selectedAnn) {
                const del = document.createElement('button');
                del.className = 'tool-btn';
                del.style.color = '#DC2626';
                del.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#DC2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
                del.onclick = () => this.deleteSelected();
                tb.appendChild(del);
            }
            
            this.updateTrasseProps();
        }
        ensureTrasseMeta(ann) {
            if (!ann) return;
            ann.meta = ann.meta || {};
            if (!ann.meta.surface) ann.meta.surface = this.currentSurface;
            if (!ann.meta.dn) ann.meta.dn = this.currentDN;
        }
        updateTrasseProps() {
            const panel = document.getElementById('trasseProps');
            if (!panel) return;
            const ann = this.selectedAnn;
            const tool = ann && TOOLS[ann.tool];
            if (!ann || !tool || tool.id !== 'TRASSE') { panel.style.display = 'none'; return; }
            this.ensureTrasseMeta(ann);
            panel.style.display = 'block';
            const surfOptions = SURFACES.map(s => `<option value="${s.value}" ${ann.meta.surface===s.value?'selected':''}>${s.label}</option>`).join('');
            const dnOptions = DNS.map(d => `<option value="${d.value}" ${ann.meta.dn===d.value?'selected':''}>${d.label}</option>`).join('');
            panel.innerHTML = `
                <h4>Trasse Eigenschaften</h4>
                <div class="row">
                    <label>Oberfläche</label>
                    <select data-prop="surface">${surfOptions}</select>
                    <label>DN</label>
                    <select data-prop="dn">${dnOptions}</select>
                </div>
            `;
            panel.querySelectorAll('select').forEach(sel => {
                sel.onchange = () => {
                    const prop = sel.dataset.prop;
                    ann.meta[prop] = sel.value;
                    this.render();
                    this.renderLayers();
                };
            });
        }
        renderLegend() {
            const list = document.getElementById('legendList'); list.innerHTML = '';
            Object.values(TOOLS).filter(t => t.type !== 'utility').forEach(t => {
                const item = document.createElement('div'); item.className = 'legend-item';
                let symbolHtml;
                if (t.type === 'line' || t.type === 'arrow' || t.type === 'dimension') {
                    symbolHtml = `<span style="width:20px;height:4px;background:${t.color};border-radius:2px"></span>`;
                } else if (t.symbol === '□□') {
                    // Doppel-Rechteck für DAZK
                    symbolHtml = `<span style="display:inline-flex;gap:2px"><span style="width:8px;height:12px;background:${t.color};border-radius:1px"></span><span style="width:8px;height:12px;background:${t.color};border-radius:1px"></span></span>`;
                } else if (t.symbol === '□') {
                    symbolHtml = `<span style="width:14px;height:14px;background:${t.color};border-radius:2px"></span>`;
                } else if (t.symbol === '◆') {
                    symbolHtml = `<span style="width:14px;height:14px;background:${t.color};transform:rotate(45deg);border-radius:2px"></span>`;
                } else if (t.symbol === '⚠') {
                    symbolHtml = `<span style="color:${t.color};font-size:16px">⚠</span>`;
                } else {
                    symbolHtml = `<span style="color:${t.color}">${t.symbol||'●'}</span>`;
                }
                item.innerHTML = `${symbolHtml}<span>${t.name}</span>`;
                list.appendChild(item);
            });
        }
        renderLayers() {
            const list = document.getElementById('layerList'); list.innerHTML = '';
            if (!this.annotations.length) { list.innerHTML = '<p class="text-muted" style="font-size:12px">Keine Elemente</p>'; return; }
            [...this.annotations].reverse().forEach(a => {
                const t = TOOLS[a.tool]; if (!t) return;
                const item = document.createElement('div'); item.className = 'layer-item' + (a === this.selectedAnn ? ' selected' : '');
                item.onclick = () => { this.selectedAnn = a; this.selectedTool = 'SELECT'; if (a.tool === 'TRASSE') this.ensureTrasseMeta(a); this.renderToolbar(); this.renderLayers(); this.render(); };
                let lbl = t.name; if (a.computed?.lengthMeters) lbl += ` (${a.computed.lengthMeters.toFixed(1)}m)`; if (a.text) lbl = a.text.substring(0,20);
                item.innerHTML = `<span style="color:${t.color}">${t.symbol||'━'}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis">${lbl}</span>`;
                list.appendChild(item);
            });
        }
        getAnnotations() { return this.annotations; }
        
        zoomIn() {
            this.scale = Math.min(this.scale * 1.25, 3);
            this.applyZoom();
        }
        
        zoomOut() {
            this.scale = Math.max(this.scale * 0.8, 0.2);
            this.applyZoom();
        }
        
        zoomReset() {
            const toolbarReserve = 150;
            const headerReserve = 120;
            const margin = 32;
            const maxW = Math.max(200, window.innerWidth - margin);
            const maxH = Math.max(200, window.innerHeight - (toolbarReserve + headerReserve));
            this.scale = Math.min(maxW / this.image.width, maxH / this.image.height, 1);
            this.applyZoom();
        }
        
        applyZoom() {
            this.canvas.width = this.image.width * this.scale;
            this.canvas.height = this.image.height * this.scale;
            this.render();
        }
        
        async renderToImage() {
            // Begrenze Canvas-Auflösung für bessere Annotation-Sichtbarkeit und kleinere Dateigröße
            const maxDim = 2000;
            const ratio = Math.min(maxDim / this.image.width, maxDim / this.image.height, 1);
            const c = document.createElement('canvas');
            c.width = Math.round(this.image.width * ratio);
            c.height = Math.round(this.image.height * ratio);
            const ctx = c.getContext('2d');
            ctx.drawImage(this.image, 0, 0, c.width, c.height);
            // Speichere Editor-Zustand und setze PDF-Rendering-Werte
            const os = this.scale, oc = this.ctx, om = this.sizeMultiplier;
            this.scale = ratio;
            // Annotationen proportional vergrößern damit sie im PDF sichtbar bleiben
            this.sizeMultiplier = Math.max(om, 1 / ratio);
            this.ctx = ctx;
            this.annotations.forEach(a => this.drawAnn(a, false));
            this.scale = os; this.ctx = oc; this.sizeMultiplier = om;
            return c.toDataURL('image/jpeg', 0.9);
        }
    }

    // MAIN APP
    class App {
        constructor() { this.db = new Database(); this.map = null; this.editor = new Editor(); this.currentProject = null; this.currentPhoto = null; this.tempContacts = []; this.editingId = null; }
        async init() { await this.db.init(); this.renderProjectList(); }
        
        showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id + 'View').classList.add('active');
            const back = document.getElementById('backBtn'), title = document.getElementById('headerTitle'), actions = document.getElementById('headerActions');
            if (id === 'projectList') { back.classList.remove('visible'); title.textContent = ''; actions.innerHTML = ''; }
            else if (id === 'projectForm') { back.classList.add('visible'); title.textContent = this.editingId ? 'Bearbeiten' : 'Neues Projekt'; actions.innerHTML = ''; }
            else if (id === 'projectDetail') { back.classList.add('visible'); title.textContent = this.currentProject?.projectName || ''; actions.innerHTML = '<button class="btn btn-secondary btn-sm" onclick="app.editProject()" style="padding:6px 8px;min-height:36px"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button class="btn btn-secondary btn-sm" onclick="app.deleteProject()" style="padding:6px 8px;min-height:36px;color:#dc2626"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button><button class="btn btn-secondary btn-sm" onclick="app.exportProject()" style="padding:6px 8px;min-height:36px"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button><button class="btn btn-primary btn-sm" onclick="app.exportPDF()" style="padding:6px 10px;min-height:36px">PDF</button>'; }
        }
        goBack() { this.showView('projectList'); this.renderProjectList(); }

        async renderProjectList() {
            const projects = await this.db.getAll('projects'), grid = document.getElementById('projectGrid');
            if (!projects.length) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><h3>Keine Projekte</h3><p>Erstellen Sie Ihr erstes Projekt</p><button class="btn btn-primary" onclick="app.showCreateProject()">+ Neues Projekt</button></div>'; return; }
            projects.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            grid.innerHTML = projects.map(p => {
                const st = {'offen':'Offen','in-arbeit':'In Arbeit','abgeschlossen':'Abgeschlossen'}[p.status] || p.status;
                return `<div class="project-card" onclick="app.openProject('${p.id}')"><div class="project-card-header"><div class="project-card-title">${this.esc(p.projectName)}</div><div class="project-card-subtitle">${this.esc(p.customer)}</div></div><div class="project-card-meta"><span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> ${new Date(p.createdAt).toLocaleDateString('de-DE')}</span><span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${this.esc(p.location||'')}</span><span class="status-badge status-${p.status}">${st}</span></div><div class="project-card-actions"><button class="project-action-btn" onclick="event.stopPropagation();app.quickCamera('${p.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button><button class="project-action-btn" onclick="event.stopPropagation();app.quickImport('${p.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></button><button class="project-action-btn" onclick="event.stopPropagation();app.exportProject('${p.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button></div></div>`;
            }).join('');
        }
        filterProjects() {
            const s = document.getElementById('searchInput').value.toLowerCase(), st = document.getElementById('statusFilter').value;
            document.querySelectorAll('.project-card').forEach(c => {
                const t = (c.querySelector('.project-card-title')?.textContent||'').toLowerCase(), sub = (c.querySelector('.project-card-subtitle')?.textContent||'').toLowerCase(), cls = c.querySelector('.status-badge')?.className||'';
                c.style.display = (!s || t.includes(s) || sub.includes(s)) && (!st || cls.includes('status-'+st)) ? '' : 'none';
            });
        }

        showCreateProject() { this.editingId = null; this.tempContacts = []; document.getElementById('projectForm').reset(); this.renderContactList(); this.showView('projectForm'); }
        
        autoFillProject() {
            const f = document.getElementById('projectForm');
            const projektNr = 'P123456';
            f.projectNumber.value = projektNr;
            f.customer.value = 'Nhas City Chicken';
            f.location.value = 'Karl-Marx-Platz 3, 12043 Berlin';
            f.status.value = 'offen';
            f.description.value = 'Neuverlegung Glasfaser-Hausanschluss';
            
            // Ersteller: Raimon Goly auswählen
            f.creator.value = 'Raimon Goly|Raimon.Goly@qfm.eu|+49 151 14577 327';
            f.creatorCustom.style.display = 'none';
            
            // Ansprechpartner hinzufügen
            this.tempContacts = [
                { name: 'Max Mustermann', role: 'Bauleiter', phone: '+49 170 1234567', email: 'max.mustermann@beispiel.de' },
                { name: 'Erika Musterfrau', role: 'Eigentümerin', phone: '+49 171 9876543', email: 'erika.musterfrau@beispiel.de' }
            ];
            this.renderContactList();
            
            this.updateProjectName();
            this.toast('Beispieldaten eingefügt', 'success');
        }
        
        updateProjectName() {
            const f = document.getElementById('projectForm');
            const projektNr = f.projectNumber.value.trim();
            const kunde = f.customer.value.trim();
            const adresse = f.location.value.trim();
            
            // Extrahiere nur die Straße (ohne PLZ und Stadt)
            let strasse = adresse;
            // Entferne PLZ (5 Ziffern) und alles danach
            const plzMatch = adresse.match(/^(.+?),?\s*\d{5}/);
            if (plzMatch) {
                strasse = plzMatch[1].trim().replace(/,\s*$/, '');
            } else {
                // Falls kein PLZ-Muster, nimm alles vor dem ersten Komma
                const kommaIdx = adresse.indexOf(',');
                if (kommaIdx > 0) {
                    strasse = adresse.substring(0, kommaIdx).trim();
                }
            }
            
            // Generiere Projektname
            if (projektNr && kunde && strasse) {
                f.projectName.value = `${projektNr}_${kunde}_${strasse}`;
            } else if (projektNr && kunde) {
                f.projectName.value = `${projektNr}_${kunde}`;
            } else if (projektNr) {
                f.projectName.value = projektNr;
            }
        }
        
        onCreatorChange(select) {
            const f = document.getElementById('projectForm');
            const customInput = f.creatorCustom;
            if (select.value === '_custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }
        
        getCreatorData() {
            const f = document.getElementById('projectForm');
            if (f.creator.value === '_custom') {
                return { name: f.creatorCustom.value, email: '', phone: '' };
            } else if (f.creator.value) {
                const parts = f.creator.value.split('|');
                return { name: parts[0] || '', email: parts[1] || '', phone: parts[2] || '' };
            }
            return { name: '', email: '', phone: '' };
        }
        
        async editProject() {
            if (!this.currentProject) return;
            this.editingId = this.currentProject.id; this.tempContacts = [...(this.currentProject.contacts||[])];
            const f = document.getElementById('projectForm');
            f.projectNumber.value = this.currentProject.projectNumber||''; f.projectName.value = this.currentProject.projectName||''; f.customer.value = this.currentProject.customer||'';
            f.status.value = this.currentProject.status||'offen'; f.description.value = this.currentProject.description||'';
            f.location.value = this.currentProject.location||'';
            // Ersteller aus gespeicherten Daten setzen
            const savedCreator = this.currentProject.creator || '';
            const savedEmail = this.currentProject.creatorEmail || '';
            const savedPhone = this.currentProject.creatorPhone || '';
            // Prüfe ob es ein vordefinierter Ersteller ist
            const predefinedValue = `${savedCreator}|${savedEmail}|${savedPhone}`;
            const options = Array.from(f.creator.options);
            const matchingOption = options.find(o => o.value === predefinedValue);
            if (matchingOption) {
                f.creator.value = predefinedValue;
                f.creatorCustom.style.display = 'none';
            } else if (savedCreator) {
                f.creator.value = '_custom';
                f.creatorCustom.value = savedCreator;
                f.creatorCustom.style.display = 'block';
            } else {
                f.creator.value = '';
                f.creatorCustom.style.display = 'none';
            }
            this.renderContactList(); this.showView('projectForm');
        }
        async deleteProject() {
            if (!this.currentProject) return;
            const confirmed = confirm(`Projekt "${this.currentProject.projectName}" wirklich löschen?\n\nAlle Fotos werden ebenfalls gelöscht.`);
            if (!confirmed) return;
            
            try {
                // Lösche alle Fotos des Projekts
                const photos = await this.db.getByIndex('photos', 'projectId', this.currentProject.id);
                for (const photo of photos) {
                    await this.db.delete('photos', photo.id);
                }
                // Lösche das Projekt
                await this.db.delete('projects', this.currentProject.id);
                this.currentProject = null;
                this.toast('Projekt gelöscht', 'success');
                this.goBack();
            } catch (err) {
                this.toast('Fehler beim Löschen: ' + err.message, 'error');
            }
        }
        async saveProject(e) {
            e.preventDefault(); const f = e.target;
            const creatorData = this.getCreatorData();
            const p = { id: this.editingId || 'p'+Date.now(), projectNumber: f.projectNumber.value, projectName: f.projectName.value, customer: f.customer.value, status: f.status.value, description: f.description.value, location: f.location.value, creator: creatorData.name, creatorEmail: creatorData.email, creatorPhone: creatorData.phone, contacts: this.tempContacts, lat: null, lon: null, createdAt: this.editingId ? (this.currentProject?.createdAt || new Date().toISOString()) : new Date().toISOString(), updatedAt: new Date().toISOString() };
            
            // Versuche Online-Geocoding mit Fallback-Kette
            try {
                const coords = await this.geocodeAddress(p.location);
                if (coords) {
                    p.lat = coords.lat;
                    p.lon = coords.lon;
                    console.log('Geocoding erfolgreich:', coords);
                } else {
                    console.log('Keine Ergebnisse, nutze lokales Geocoding');
                    this.setLocalCoordinates(p, p.location);
                }
            } catch (err) {
                console.warn('Online Geocoding nicht möglich, nutze lokales Fallback:', err);
                this.setLocalCoordinates(p, p.location);
            }
            
            await this.db.put('projects', p); this.toast('Gespeichert', 'success'); this.currentProject = p; await this.openProject(p.id);
        }
        
        // Zentrale Geocoding-Methode mit Fallback-Kette
        // Reihenfolge: 1) JSONP (umgeht CSP/CORS bei Neocities etc.), 2) fetch, 3) Photon fetch
        async geocodeAddress(address) {
            const query = encodeURIComponent(address);
            
            // Hilfsfunktion: bestes Ergebnis aus Nominatim-Array wählen
            const pickBest = (results) => {
                if (!results || !Array.isArray(results) || results.length === 0) return null;
                let best = results[0];
                for (const r of results) {
                    if (r.type === 'house' || r.type === 'building' || r.class === 'building') { best = r; break; }
                    if (r.type === 'street' || r.type === 'road' || r.class === 'highway') { best = r; }
                }
                return { lat: parseFloat(best.lat), lon: parseFloat(best.lon), display: best.display_name || address };
            };
            
            // Versuch 1: Nominatim JSONP (funktioniert auch bei CSP connect-src Einschränkungen)
            try {
                const result = await this._geocodeJSONP(query);
                if (result) { console.log('Geocoding via JSONP erfolgreich'); return result; }
            } catch (e1) {
                console.warn('JSONP-Geocoding:', e1.message);
            }
            
            // Versuch 2: Nominatim fetch
            try {
                const ac = new AbortController();
                const t = setTimeout(() => ac.abort(), 8000);
                const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=de&addressdetails=1&limit=5&email=app@qfm.eu`, { signal: ac.signal });
                clearTimeout(t);
                if (r.ok) { const result = pickBest(await r.json()); if (result) { console.log('Geocoding via fetch erfolgreich'); return result; } }
            } catch (e2) {
                console.warn('Fetch-Geocoding:', e2.message);
            }
            
            // Versuch 3: Photon API (Komoot, OSM-basiert, anderer Server)
            try {
                const ac = new AbortController();
                const t = setTimeout(() => ac.abort(), 8000);
                const r = await fetch(`https://photon.komoot.io/api/?q=${query}&lang=de&limit=5`, { signal: ac.signal });
                clearTimeout(t);
                if (r.ok) {
                    const data = await r.json();
                    if (data.features && data.features.length > 0) {
                        const f = data.features[0], c = f.geometry.coordinates, p = f.properties || {};
                        console.log('Geocoding via Photon erfolgreich');
                        return { lat: c[1], lon: c[0], display: [p.street, p.housenumber, p.city].filter(Boolean).join(' ') || address };
                    }
                }
            } catch (e3) {
                console.warn('Photon-Geocoding:', e3.message);
            }
            
            throw new Error('Alle Geocoding-Dienste fehlgeschlagen');
        }
        
        // Nominatim JSONP – umgeht CSP connect-src (Neocities u.a.)
        _geocodeJSONP(query) {
            return new Promise((resolve, reject) => {
                const cb = '_gc' + Date.now() + Math.random().toString(36).slice(2, 7);
                const timer = setTimeout(() => { done(); reject(new Error('Timeout')); }, 10000);
                const done = () => { clearTimeout(timer); delete window[cb]; const s = document.getElementById(cb); if (s) s.remove(); };
                
                window[cb] = (data) => {
                    done();
                    if (!data || !Array.isArray(data) || data.length === 0) { resolve(null); return; }
                    let best = data[0];
                    for (const r of data) {
                        if (r.type === 'house' || r.type === 'building') { best = r; break; }
                        if (r.type === 'street' || r.type === 'road') { best = r; }
                    }
                    resolve({ lat: parseFloat(best.lat), lon: parseFloat(best.lon), display: best.display_name || '' });
                };
                
                const s = document.createElement('script');
                s.id = cb;
                s.src = `https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=de&limit=5&email=app@qfm.eu&json_callback=${cb}`;
                s.onerror = () => { done(); reject(new Error('Script-Ladefehler')); };
                document.head.appendChild(s);
            });
        }

        setLocalCoordinates(project, location) {
            const loc = location.toLowerCase();
            
            // PLZ-basierte Koordinaten (erste 2 Ziffern = Region)
            const plzMatch = location.match(/\b(\d{5})\b/);
            if (plzMatch) {
                const plz = plzMatch[1];
                const plz2 = plz.substring(0, 2);
                const plzCoords = {
                    '01': [51.05, 13.74], '02': [51.18, 14.43], '03': [51.75, 14.33], '04': [51.34, 12.37],
                    '06': [51.48, 11.97], '07': [50.93, 11.59], '08': [50.72, 12.49], '09': [50.83, 12.92],
                    '10': [52.52, 13.40], '12': [52.47, 13.43], '13': [52.57, 13.39], '14': [52.39, 13.07],
                    '15': [52.34, 14.05], '16': [52.76, 13.28], '17': [53.63, 13.37], '18': [54.09, 12.13],
                    '19': [53.63, 11.41], '20': [53.55, 10.00], '21': [53.46, 9.97], '22': [53.57, 10.02],
                    '23': [53.87, 10.69], '24': [54.32, 10.14], '25': [53.87, 9.48], '26': [53.14, 8.22],
                    '27': [53.08, 8.80], '28': [53.08, 8.80], '29': [52.97, 10.57], '30': [52.37, 9.73],
                    '31': [52.16, 9.95], '32': [52.02, 8.53], '33': [51.93, 8.38], '34': [51.31, 9.48],
                    '35': [50.56, 8.67], '36': [50.55, 9.68], '37': [51.53, 9.93], '38': [52.27, 10.52],
                    '39': [52.13, 11.63], '40': [51.23, 6.77], '41': [51.19, 6.44], '42': [51.26, 7.15],
                    '44': [51.51, 7.47], '45': [51.46, 7.01], '46': [51.54, 6.77], '47': [51.43, 6.76],
                    '48': [51.96, 7.63], '49': [52.28, 8.05], '50': [50.94, 6.96], '51': [50.94, 7.13],
                    '52': [50.78, 6.08], '53': [50.74, 7.10], '54': [49.75, 6.64], '55': [49.99, 8.25],
                    '56': [50.36, 7.60], '57': [50.87, 7.73], '58': [51.36, 7.47], '59': [51.66, 7.82],
                    '60': [50.11, 8.68], '61': [50.22, 8.62], '63': [50.00, 9.02], '64': [49.87, 8.65],
                    '65': [50.08, 8.24], '66': [49.24, 7.00], '67': [49.45, 8.44], '68': [49.49, 8.47],
                    '69': [49.41, 8.69], '70': [48.78, 9.18], '71': [48.73, 9.10], '72': [48.52, 9.05],
                    '73': [48.70, 9.79], '74': [49.14, 9.22], '75': [48.89, 8.70], '76': [49.01, 8.40],
                    '77': [48.53, 7.85], '78': [47.99, 8.53], '79': [47.99, 7.84], '80': [48.14, 11.58],
                    '81': [48.12, 11.60], '82': [48.02, 11.47], '83': [47.86, 12.13], '84': [48.46, 12.17],
                    '85': [48.40, 11.74], '86': [48.37, 10.90], '87': [47.73, 10.31], '88': [47.66, 9.48],
                    '89': [48.40, 9.99], '90': [49.45, 11.08], '91': [49.60, 11.01], '92': [49.02, 12.10],
                    '93': [49.02, 12.10], '94': [48.57, 13.45], '95': [50.09, 11.96], '96': [50.27, 10.96],
                    '97': [49.79, 9.95], '98': [50.68, 10.93], '99': [50.98, 11.03]
                };
                if (plzCoords[plz2]) {
                    project.lat = plzCoords[plz2][0];
                    project.lon = plzCoords[plz2][1];
                    return;
                }
            }
            
            // Stadt-basierte Koordinaten
            const cities = {
                'berlin': [52.520008, 13.404954], 'hamburg': [53.551086, 9.993682],
                'münchen': [48.137154, 11.576124], 'munich': [48.137154, 11.576124],
                'köln': [50.937531, 6.960279], 'cologne': [50.937531, 6.960279],
                'frankfurt': [50.110924, 8.682127], 'stuttgart': [48.775846, 9.182932],
                'düsseldorf': [51.227741, 6.773456], 'dortmund': [51.513587, 7.465298],
                'essen': [51.455643, 7.011555], 'leipzig': [51.339695, 12.373075],
                'bremen': [53.079296, 8.801694], 'dresden': [51.050409, 13.737262],
                'hannover': [52.375892, 9.732010], 'nürnberg': [49.452030, 11.076750],
                'duisburg': [51.434408, 6.762329], 'bochum': [51.481845, 7.216236],
                'wuppertal': [51.256213, 7.150764], 'bielefeld': [52.021240, 8.534690],
                'bonn': [50.737430, 7.098207], 'münster': [51.962940, 7.628690],
                'karlsruhe': [49.006890, 8.403653], 'mannheim': [49.487459, 8.466039],
                'augsburg': [48.370545, 10.897790], 'wiesbaden': [50.078218, 8.239761],
                'gelsenkirchen': [51.517744, 7.085717], 'mönchengladbach': [51.180454, 6.442130],
                'braunschweig': [52.268874, 10.526770], 'chemnitz': [50.827847, 12.921370],
                'kiel': [54.323292, 10.122765], 'aachen': [50.775346, 6.083887],
                'halle': [51.482990, 11.969620], 'magdeburg': [52.120533, 11.627624],
                'freiburg': [47.999008, 7.842104], 'krefeld': [51.338470, 6.585170],
                'lübeck': [53.869720, 10.686390], 'oberhausen': [51.496334, 6.863610],
                'erfurt': [50.978565, 11.029541], 'mainz': [49.992862, 8.247253],
                'rostock': [54.092441, 12.099147], 'kassel': [51.312711, 9.479746],
                'hagen': [51.360561, 7.474755], 'hamm': [51.673580, 7.815980],
                'saarbrücken': [49.240157, 6.996933], 'mülheim': [51.432470, 6.883090],
                'potsdam': [52.390569, 13.064473], 'ludwigshafen': [49.477230, 8.445180],
                'oldenburg': [53.143890, 8.213860], 'leverkusen': [51.049610, 6.987620],
                'osnabrück': [52.279110, 8.047180], 'solingen': [51.165218, 7.067620],
                'heidelberg': [49.398750, 8.672434], 'herne': [51.538570, 7.225850],
                'neuss': [51.198280, 6.688450], 'darmstadt': [49.872825, 8.651193],
                'paderborn': [51.718920, 8.754350], 'regensburg': [49.013430, 12.101620],
                'ingolstadt': [48.764660, 11.423180], 'würzburg': [49.791304, 9.953355],
                'wolfsburg': [52.423490, 10.786410], 'ulm': [48.401082, 9.987608],
                'heilbronn': [49.142000, 9.218790], 'pforzheim': [48.892150, 8.694530],
                'göttingen': [51.533970, 9.935350], 'bottrop': [51.524470, 6.928680],
                'trier': [49.749920, 6.637140], 'recklinghausen': [51.586570, 7.194890],
                'reutlingen': [48.493040, 9.204880], 'bremerhaven': [53.549720, 8.580360],
                'koblenz': [50.356943, 7.594063], 'bergisch gladbach': [50.992530, 7.129970],
                'jena': [50.927054, 11.586260], 'remscheid': [51.178950, 7.189620],
                'erlangen': [49.589690, 11.007810], 'moers': [51.451270, 6.619470],
                'siegen': [50.874270, 8.024090], 'hildesheim': [52.150780, 9.950820],
                'salzgitter': [52.153810, 10.400790], 'cottbus': [51.756590, 14.332870]
            };
            
            for (const [city, coords] of Object.entries(cities)) {
                if (loc.includes(city)) {
                    project.lat = coords[0];
                    project.lon = coords[1];
                    return;
                }
            }
            
            // Default: Deutschland Mitte
            project.lat = 51.165691;
            project.lon = 10.451526;
        }
        cancelProjectForm() { this.goBack(); }

        showContactModal() { ['contactName','contactRole','contactPhone','contactEmail'].forEach(id => document.getElementById(id).value = ''); document.getElementById('contactModal').classList.add('active'); }
        closeContactModal() { document.getElementById('contactModal').classList.remove('active'); }
        addContact() {
            const n = document.getElementById('contactName').value.trim(); if (!n) { this.toast('Name erforderlich', 'error'); return; }
            this.tempContacts.push({ id: 'c'+Date.now(), name: n, role: document.getElementById('contactRole').value.trim(), phone: document.getElementById('contactPhone').value.trim(), email: document.getElementById('contactEmail').value.trim() });
            this.renderContactList(); this.closeContactModal();
        }
        removeContact(id) { this.tempContacts = this.tempContacts.filter(c => c.id !== id); this.renderContactList(); }
        renderContactList() {
            const list = document.getElementById('contactList');
            if (!this.tempContacts.length) { list.innerHTML = '<p class="text-muted text-center">Keine Ansprechpartner</p>'; return; }
            list.innerHTML = this.tempContacts.map(c => `<div class="contact-item"><div class="contact-avatar">${c.name.charAt(0).toUpperCase()}</div><div class="contact-info"><div class="contact-name">${this.esc(c.name)}</div><div class="contact-role">${this.esc(c.role||'-')}${c.phone?' • '+this.esc(c.phone):''}</div></div><button class="btn btn-secondary btn-sm" onclick="app.removeContact('${c.id}')">×</button></div>`).join('');
        }

        async openProject(id) { const p = await this.db.get('projects', id); if (!p) { this.toast('Nicht gefunden', 'error'); return; } this.currentProject = p; this.showView('projectDetail'); this.switchTab('photos'); }
        switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === tab+'Tab'));
            if (tab === 'photos') this.renderPhotoGrid(); else if (tab === 'map') this.initMap(); else if (tab === 'quantities') this.renderQuantityTable();
        }

        async renderPhotoGrid() {
            const photos = await this.db.getByIndex('photos', 'projectId', this.currentProject.id), grid = document.getElementById('photoGrid');
            grid.innerHTML = `<div class="photo-card add-photo-card" onclick="document.getElementById('cameraInput').click()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg><br>Aufnehmen</div><div class="photo-card add-photo-card" onclick="document.getElementById('importInput').click()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg><br>Importieren</div>`;
            photos.forEach(ph => {
                const card = document.createElement('div'); card.className = 'photo-card'; card.onclick = () => this.openEditor(ph.id);
                card.innerHTML = `<img src="${ph.thumbnail||ph.dataUrl}">${ph.isMapSnapshot?'<span class="photo-card-badge">Karte</span>':''}`;
                grid.appendChild(card);
            });
        }
        async handlePhotoCapture(e) { if (e.target.files.length) { await this.addPhotos(e.target.files); e.target.value = ''; } }
        async handlePhotoImport(e) { if (e.target.files.length) { await this.addPhotos(e.target.files); e.target.value = ''; } }
        async addPhotos(files) {
            for (const f of files) {
                const dataUrl = await this.readFile(f), thumb = await this.createThumb(dataUrl, 300);
                await this.db.put('photos', { id: 'ph'+Date.now()+'_'+Math.random().toString(36).substr(2,6), projectId: this.currentProject.id, name: f.name, dataUrl, thumbnail: thumb, annotations: [], isMapSnapshot: false, mapMetadata: null, createdAt: new Date().toISOString() });
            }
            this.toast(files.length + ' Foto(s) hinzugefügt', 'success'); this.renderPhotoGrid();
        }
        async quickCamera(id) { this.currentProject = await this.db.get('projects', id); document.getElementById('cameraInput').click(); }
        async quickImport(id) { this.currentProject = await this.db.get('projects', id); document.getElementById('importInput').click(); }

        initMap() {
            const p = this.currentProject;
            // Fallback-Koordinaten wenn keine vorhanden (Deutschland Mitte)
            const lat = p?.lat || 51.165691;
            const lon = p?.lon || 10.451526;
            const hasCoords = p?.lat && p?.lon;
            
            console.log('initMap aufgerufen, Projekt:', p?.projectName, 'lat:', lat, 'lon:', lon, 'hasCoords:', hasCoords);
            
            // Aktualisiere Location-Bar
            const locText = document.getElementById('mapLocationText');
            if (locText) {
                if (hasCoords) {
                    locText.textContent = `${p.location || 'Standort'} (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
                } else {
                    locText.textContent = `${p?.location || 'Kein Standort'} – nicht georeferenziert`;
                    locText.style.color = 'var(--warning)';
                }
            }
            
            setTimeout(() => {
                const mapEl = document.getElementById('map');
                if (!mapEl) return;
                
                // Falls Karte bereits existiert, zerstören
                if (this.map) {
                    try { this.map.remove(); } catch(e) {}
                    this.map = null;
                }
                
                try {
                    console.log('Erstelle Leaflet Karte bei:', lat, lon);
                    
                    // Karte initialisieren
                    const map = L.map('map', { 
                        zoomControl: true,
                        attributionControl: true
                    }).setView([lat, lon], hasCoords ? 16 : 6);
                    this.map = map;
                    
                    // OSM Tiles mit korrekter Attribution
                    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                        maxZoom: 19,
                        crossOrigin: 'anonymous'
                    }).addTo(map);
                    
                    // Marker für Projektstandort (nur wenn Koordinaten vorhanden)
                    if (hasCoords) {
                        L.marker([lat, lon]).addTo(map).bindPopup(p.location || 'Projektstandort');
                    }
                    
                    // Hinweis wenn keine Koordinaten
                    if (!hasCoords) {
                        this.toast('Standardposition – bitte "Neu suchen" oder "GPS" nutzen', 'info');
                    }
                } catch (err) {
                    console.error('Kartenfehler:', err);
                    this.toast('Kartenfehler – bitte Seite neu laden', 'error');
                }
            }, 100);
        }
        
        mapZoom(d) { 
            if (this.map) {
                this.map.setZoom(this.map.getZoom() + d);
            }
        }
        
        async reGeocodeProject() {
            const p = this.currentProject;
            if (!p || !p.location) { 
                this.toast('Keine Adresse vorhanden', 'error'); 
                return; 
            }
            
            this.toast('Suche Adresse...', 'info');
            try {
                const coords = await this.geocodeAddress(p.location);
                if (coords) {
                    p.lat = coords.lat;
                    p.lon = coords.lon;
                    await this.db.put('projects', p);
                    this.toast(`Gefunden: ${coords.display.slice(0, 50)}`, 'success');
                    this.initMap();
                } else {
                    this.toast('Adresse nicht gefunden – bitte GPS nutzen', 'error');
                }
            } catch (err) {
                console.error('Geocoding error:', err);
                this.toast('Geocoding fehlgeschlagen – bitte GPS nutzen', 'error');
            }
        }
        
        async useGPSForProject() {
            const p = this.currentProject;
            if (!p) { 
                this.toast('Kein Projekt', 'error'); 
                return; 
            }
            
            if (!navigator.geolocation) {
                this.toast('GPS nicht verfügbar', 'error');
                return;
            }
            
            this.toast('Ermittle GPS-Position...', 'info');
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    p.lat = position.coords.latitude;
                    p.lon = position.coords.longitude;
                    await this.db.put('projects', p);
                    this.toast(`GPS: ${p.lat.toFixed(5)}, ${p.lon.toFixed(5)}`, 'success');
                    this.initMap();
                },
                (error) => {
                    console.error('GPS error:', error);
                    let msg = 'GPS-Fehler';
                    if (error.code === 1) msg = 'GPS-Zugriff verweigert';
                    else if (error.code === 2) msg = 'Position nicht verfügbar';
                    else if (error.code === 3) msg = 'GPS Timeout';
                    this.toast(msg, 'error');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        async saveMapSnapshot() {
            const p = this.currentProject;
            if (!p) { this.toast('Kein Projekt', 'error'); return; }
            const mapEl = document.getElementById('map');
            if (!mapEl) { this.toast('Karte nicht bereit', 'error'); return; }

            try {
                this.toast('Speichern...', 'info');
                
                // Leaflet Controls temporär ausblenden
                const ctrls = mapEl.querySelectorAll('.leaflet-control-container');
                ctrls.forEach(c => c.style.display = 'none');

                const canvas = await html2canvas(mapEl, { useCORS: true, backgroundColor: '#E8E8E8', scale: 2 });
                const dataUrl = canvas.toDataURL('image/jpeg', 0.92);

                // Wieder einblenden
                ctrls.forEach(c => c.style.display = '');

                const thumb = await this.createThumb(dataUrl, 300);
                await this.db.put('photos', { 
                    id: 'ph' + Date.now(), 
                    projectId: p.id, 
                    name: 'Karte_' + new Date().toISOString().split('T')[0] + '.png', 
                    dataUrl, 
                    thumbnail: thumb, 
                    annotations: [], 
                    isMapSnapshot: true, 
                    mapMetadata: this.map ? {
                        centerLat: this.map.getCenter().lat,
                        centerLon: this.map.getCenter().lng,
                        zoomLevel: this.map.getZoom(),
                        pixelWidth: canvas.width,
                        pixelHeight: canvas.height,
                        boundingBox: {
                            north: this.map.getBounds().getNorth(),
                            south: this.map.getBounds().getSouth(),
                            west: this.map.getBounds().getWest(),
                            east: this.map.getBounds().getEast()
                        }
                    } : null,
                    createdAt: new Date().toISOString() 
                });
                this.toast('Karte gespeichert', 'success'); 
                this.switchTab('photos');
            } catch (e) {
                console.error(e);
                this.toast('Fehler beim Speichern', 'error');
            }
        }

        async openEditor(id) {
            const ph = await this.db.get('photos', id); if (!ph) return; this.currentPhoto = ph;
            const img = new Image();
            img.onload = () => { document.getElementById('editorTitle').textContent = ph.name; document.getElementById('editorContainer').classList.add('active'); this.editor.init(ph, img); };
            img.src = ph.dataUrl;
        }
        closeEditor() { document.getElementById('editorContainer').classList.remove('active'); this.currentPhoto = null; }
        async saveEditor() { if (!this.currentPhoto) return; this.currentPhoto.annotations = this.editor.getAnnotations(); await this.db.put('photos', this.currentPhoto); this.toast('Gespeichert', 'success'); this.closeEditor(); this.renderPhotoGrid(); }
        editorUndo() { this.editor.undo(); }
        editorRedo() { this.editor.redo(); }
        async deletePhoto() { if (!this.currentPhoto || !confirm('Löschen?')) return; await this.db.delete('photos', this.currentPhoto.id); this.toast('Gelöscht', 'success'); this.closeEditor(); this.renderPhotoGrid(); }

        async renderQuantityTable() {
            const photos = await this.db.getByIndex('photos', 'projectId', this.currentProject.id), tbody = document.getElementById('quantityTableBody');
            const qty = {};
            const addQty = (key, name, unit, type='line') => { if (!qty[key]) qty[key] = { tool: { name, unit, type }, auto: 0, manual: null }; };
            // Init non-trasse tools
            Object.values(TOOLS).filter(t => t.unit && t.id !== 'TRASSE').forEach(t => { qty[t.id] = { tool: t, auto: 0, manual: null }; });
            // Iterate annotations
            photos.forEach(ph => (ph.annotations||[]).forEach(a => {
                const t = TOOLS[a.tool]; if (!t || !t.unit) return;
                if (a.tool === 'TRASSE') {
                    a.meta = a.meta || {};
                    const surf = a.meta.surface || 'GEHWEGPLATTE';
                    const dn = a.meta.dn || 'DN50';
                    const surfLabel = (SURFACES.find(s=>s.value===surf)||{label:surf}).label;
                    const dnLabel = (DNS.find(d=>d.value===dn)||{label:dn}).label;
                    // overall trasse
                    addQty('TRASSE_TOTAL', 'Trasse gesamt', t.unit);
                    // per DN (label ohne "Trasse")
                    addQty(`TRASSE_DN_${dn}`, dnLabel, t.unit);
                    // per surface (label ohne "Trasse")
                    addQty(`TRASSE_SURF_${surf}`, surfLabel, t.unit);
                    if (a.computed?.lengthMeters) {
                        qty['TRASSE_TOTAL'].auto += a.computed.lengthMeters;
                        qty[`TRASSE_DN_${dn}`].auto += a.computed.lengthMeters;
                        qty[`TRASSE_SURF_${surf}`].auto += a.computed.lengthMeters;
                    }
                } else if (t.type === 'line' && a.computed?.lengthMeters) {
                    qty[t.id].auto += a.computed.lengthMeters;
                } else if (t.type === 'point') {
                    qty[t.id].auto += 1;
                }
            }));
            const saved = this.currentProject.quantities || {};
            Object.keys(saved).forEach(k => { if (qty[k]) qty[k].manual = saved[k]; });

            // Sort: Trasse gesamt first, dann DN, dann Oberfläche, dann Rest alphabetisch
            const keys = Object.keys(qty);
            const orderValue = (k) => {
                if (k === 'TRASSE_TOTAL') return 0;
                if (k.startsWith('TRASSE_DN_')) return 1;
                if (k.startsWith('TRASSE_SURF_')) return 2;
                return 3;
            };
            keys.sort((a,b) => {
                const oa = orderValue(a), ob = orderValue(b);
                if (oa !== ob) return oa - ob;
                return this.qtyLabel(a, qty[a].tool).localeCompare(this.qtyLabel(b, qty[b].tool), 'de');
            });

            let pos = 1;
            tbody.innerHTML = keys.map(id => {
                const q = qty[id];
                const autoD = q.tool.type === 'line' ? q.auto.toFixed(1) : q.auto;
                const val = q.manual !== null ? q.manual : q.auto;
                const name = this.qtyLabel(id, q.tool);
                return `<tr><td>${pos++}</td><td>${name}</td><td>${q.tool.unit}</td><td style="color:#94A3B8">${autoD}</td><td><input type="number" class="quantity-input" value="${q.tool.type==='line'?val.toFixed(1):val}" step="${q.tool.type==='line'?'0.1':'1'}" onchange="app.updateQty('${id}',this.value)"></td></tr>`;
            }).join('');
        }
        async updateQty(id, val) { if (!this.currentProject.quantities) this.currentProject.quantities = {}; this.currentProject.quantities[id] = parseFloat(val); await this.db.put('projects', this.currentProject); }
        async recalculateQuantities() {
            this.currentProject.quantities = {};
            await this.db.put('projects', this.currentProject);
            await this.renderQuantityTable();
            this.toast('Neu berechnet', 'success');
        }
        qtyLabel(id, tool) {
            if (id.startsWith('SCHACHT_AZK_')) return 'AZK ' + (tool.name || '');
            if (id.startsWith('SCHACHT_DAZK_')) return 'DAZK ' + (tool.name || '');
            return tool.name || id;
        }

        async exportProject(id) {
            const pid = id || this.currentProject?.id; if (!pid) return;
            const p = await this.db.get('projects', pid), photos = await this.db.getByIndex('photos', 'projectId', pid);
            const blob = new Blob([JSON.stringify({ version: '1.0', exportedAt: new Date().toISOString(), project: p, photos }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `SiteSketch_${p.projectNumber||p.id}.json`; a.click();
            this.toast('Exportiert', 'success');
        }
        async handleJsonImport(e) {
            const f = e.target.files[0]; if (!f) return;
            try {
                const data = JSON.parse(await f.text()); if (!data.project) throw new Error('Ungültig');
                const newId = 'p'+Date.now(); data.project.id = newId;
                await this.db.put('projects', data.project);
                if (data.photos) for (const ph of data.photos) { ph.id = 'ph'+Date.now()+'_'+Math.random().toString(36).substr(2,6); ph.projectId = newId; await this.db.put('photos', ph); }
                this.toast('Importiert', 'success'); this.renderProjectList();
            } catch (err) { this.toast('Fehler: ' + err.message, 'error'); }
            e.target.value = '';
        }

        async exportPDF() {
            if (!this.currentProject) return; this.toast('PDF wird erstellt...', 'info');
            const photos = await this.db.getByIndex('photos', 'projectId', this.currentProject.id);
            
            // Sammle verwendete Werkzeuge
            const usedTools = new Set();
            photos.forEach(ph => (ph.annotations||[]).forEach(a => {
                if (TOOLS[a.tool]) usedTools.add(a.tool);
            }));
            
            // Erstelle Werkzeuglegende
            let toolsLegendHtml = '';
            if (usedTools.size > 0) {
                toolsLegendHtml = '<h2 style="margin-top:30px">Verwendete Werkzeuge</h2><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:20px">';
                usedTools.forEach(toolId => {
                    const t = TOOLS[toolId];
                    // Vollständiger Name für Schacht-Tools
                    let toolName = t.name;
                    if (toolId === 'SCHACHT_AZK_NEU') toolName = 'Schacht AZK Neu';
                    else if (toolId === 'SCHACHT_AZK_BESTAND') toolName = 'Schacht AZK Bestand';
                    else if (toolId === 'SCHACHT_DAZK_NEU') toolName = 'Schacht DAZK Neu';
                    else if (toolId === 'SCHACHT_DAZK_BESTAND') toolName = 'Schacht DAZK Bestand';
                    const colorSquare = `<div style="width:16px;height:16px;background:${t.color};border-radius:3px;margin:0 auto 4px"></div>`;
                    toolsLegendHtml += `<div style="border:1px solid #ddd;padding:8px;border-radius:6px;text-align:center">${colorSquare}<div style="font-size:10px;font-weight:bold">${toolName}</div></div>`;
                });
                toolsLegendHtml += '</div>';
            }
            
            // Berechne Mengen
            const qty = {};
            const addQty = (key, name, unit, type='line') => { if (!qty[key]) qty[key] = { tool: { name, unit, type }, auto: 0 }; };
            Object.values(TOOLS).filter(t => t.unit && t.id !== 'TRASSE').forEach(t => { qty[t.id] = { tool: t, auto: 0 }; });
            photos.forEach(ph => (ph.annotations||[]).forEach(a => {
                const t = TOOLS[a.tool]; if (!t || !t.unit) return;
                if (a.tool === 'TRASSE') {
                    a.meta = a.meta || {};
                    const surf = a.meta.surface || 'GEHWEGPLATTE';
                    const dn = a.meta.dn || 'DN50';
                    const surfLabel = (SURFACES.find(s=>s.value===surf)||{label:surf}).label;
                    const dnLabel = (DNS.find(d=>d.value===dn)||{label:dn}).label;
                    addQty('TRASSE_TOTAL', 'Trasse gesamt', t.unit);
                    addQty(`TRASSE_DN_${dn}`, dnLabel, t.unit);
                    addQty(`TRASSE_SURF_${surf}`, surfLabel, t.unit);
                    if (a.computed?.lengthMeters) {
                        qty['TRASSE_TOTAL'].auto += a.computed.lengthMeters;
                        qty[`TRASSE_DN_${dn}`].auto += a.computed.lengthMeters;
                        qty[`TRASSE_SURF_${surf}`].auto += a.computed.lengthMeters;
                    }
                } else if (t.type === 'line' && a.computed?.lengthMeters) {
                    qty[t.id].auto += a.computed.lengthMeters;
                } else if (t.type === 'point') {
                    qty[t.id].auto += 1;
                }
            }));
            const saved = this.currentProject.quantities || {};
            const qtyKeys = Object.keys(qty).filter(k => qty[k].auto > 0 || (saved[k] !== undefined && saved[k] > 0)).sort((a,b) => {
                const orderValue = k => k==='TRASSE_TOTAL'?0: k.startsWith('TRASSE_DN_')?1: k.startsWith('TRASSE_SURF_')?2:3;
                const oa = orderValue(a), ob = orderValue(b);
                if (oa !== ob) return oa - ob;
                return this.qtyLabel(a, qty[a].tool).localeCompare(this.qtyLabel(b, qty[b].tool), 'de');
            });
            
            let mengenHtml = '';
            if (qtyKeys.length > 0) {
                let pos = 1;
                const rows = qtyKeys.map(id => {
                    const q = qty[id];
                    const val = saved[id] !== undefined ? saved[id] : q.auto;
                    const name = this.qtyLabel(id, q.tool);
                    return `<tr><td>${pos++}</td><td>${name}</td><td>${q.tool.unit}</td><td style="text-align:right">${q.tool.type==='line'?val.toFixed(1):val}</td></tr>`;
                }).join('');
                mengenHtml = `<h2 style="margin-top:30px"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> Mengenaufmaß</h2><table><thead><tr><th>Pos.</th><th>Beschreibung</th><th>Einheit</th><th style="text-align:right">Menge</th></tr></thead><tbody>${rows}</tbody></table>`;
            }
            
            let photosHtml = '';
            for (const ph of photos) {
                let src = ph.dataUrl;
                if (ph.annotations && ph.annotations.length) {
                    const img = new Image(); await new Promise(r => { img.onload = r; img.src = ph.dataUrl; });
                    this.editor.photo = ph; this.editor.image = img; this.editor.annotations = ph.annotations;
                    src = await this.editor.renderToImage();
                }
                photosHtml += `<div style="page-break-inside:avoid;margin-bottom:15px"><img src="${src}" style="max-width:100%;max-height:350px;display:block;margin:0 auto"></div>`;
            }
            
            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Projektbericht - ${this.esc(this.currentProject.projectName)}</title>
<link href='https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap' rel='stylesheet'>
<style>
@page { size: A4 portrait; margin: 12mm; }
@media print { .no-print { display: none !important; } body { padding: 0; } * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } img { max-width: 100% !important; page-break-inside: avoid; } }
body { font-family: 'Roboto', -apple-system, BlinkMacSystemFont, Arial, sans-serif; padding: 15px; margin: 0; background: #fff; font-size: 12px; font-weight: 300; color: #3c3c3b; }
h1 { color: #003C71; font-weight: 700; border-bottom: 2px solid #003C71; padding-bottom: 8px; margin-bottom: 15px; font-size: 20px; }
h2 { color: #333; font-size: 14px; border-bottom: 1px solid #ddd; padding-bottom: 4px; margin-bottom: 10px; }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.info-section { background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; }
.info-section-title { font-weight: bold; color: #003C71; margin-bottom: 6px; font-size: 11px; text-transform: uppercase; }
.info-row { display: flex; margin: 3px 0; font-size: 11px; }
.info-label { width: 70px; font-weight: 500; color: #64748b; }
.info-value { flex: 1; color: #1a1a2e; }
table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
th, td { border: 1px solid #ddd; padding: 5px 8px; text-align: left; font-size: 10px; }
th { background: #003C71; color: white; }
.print-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #003C71; padding: 12px; display: flex; gap: 10px; justify-content: center; }
.print-bar button { background: white; color: #003C71; border: none; padding: 10px 20px; border-radius: 6px; font-size: 14px; font-weight: 600; }
.page-logo { position: fixed; bottom: 5mm; right: 5mm; opacity: 0.7; z-index: 9999; }
.page-logo img { height: 36px; }
</style></head><body>
<div class="print-bar no-print"><button onclick="window.print()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg> Drucken</button><button onclick="window.close()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> Schließen</button></div>
<div style="display:flex;align-items:center;gap:12px;margin-bottom:15px">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMcAAAA8CAIAAABdMjlLAAAspUlEQVR42u29aYxk15UeeM69b4sX+5IRkZH7UlWZtZPFVaQWNiWKHC1ueay25UYb4wE8/tFoA0YPBjCmPe2ZwQD+M8D0oAdtt8duNMew1eq2uustWaDUVEvcxKXEYhWrsjJryX2LjIw93n7vPfMjMquS" alt="SiteSketch" style="height:30px">
    <h1 style="margin:0;flex:1">Projektbericht</h1>
</div>
<div class="info-grid">
    <div class="info-section">
        <div class="info-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg> Projekt</div>
        <div class="info-row"><span class="info-label">Nummer:</span><span class="info-value">${this.esc(this.currentProject.projectNumber||'-')}</span></div>
        <div class="info-row"><span class="info-label">Name:</span><span class="info-value">${this.esc(this.currentProject.projectName)}</span></div>
        <div class="info-row"><span class="info-label">Datum:</span><span class="info-value">${new Date().toLocaleDateString('de-DE')}</span></div>
    </div>
    <div class="info-section">
        <div class="info-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Kunde</div>
        <div class="info-row"><span class="info-label">Name:</span><span class="info-value">${this.esc(this.currentProject.customer)}</span></div>
        <div class="info-row"><span class="info-label">Standort:</span><span class="info-value">${this.esc(this.currentProject.location||'')}</span></div>
    </div>
</div>
${this.currentProject.creator ? `<div class="info-section" style="margin-bottom:15px"><div class="info-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Ersteller</div><div class="info-row"><span class="info-label">Name:</span><span class="info-value">${this.esc(this.currentProject.creator)}</span></div>${this.currentProject.creatorEmail ? `<div class="info-row"><span class="info-label">E-Mail:</span><span class="info-value">${this.esc(this.currentProject.creatorEmail)}</span></div>` : ''}${this.currentProject.creatorPhone ? `<div class="info-row"><span class="info-label">Telefon:</span><span class="info-value">${this.esc(this.currentProject.creatorPhone)}</span></div>` : ''}</div>` : ''}
${this.currentProject.description ? '<div style="background:#f8f9fa;padding:10px;border-radius:6px;margin-bottom:15px;font-size:11px"><strong>Beschreibung:</strong> '+this.esc(this.currentProject.description)+'</div>' : ''}
${(this.currentProject.contacts && this.currentProject.contacts.length > 0) ? `<div class="info-section" style="margin-bottom:15px"><div class="info-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> Ansprechpartner</div>${this.currentProject.contacts.map(c => `<div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #eee"><div class="info-row"><span class="info-label">Name:</span><span class="info-value">${this.esc(c.name||'-')}</span></div>${c.role ? `<div class="info-row"><span class="info-label">Funktion:</span><span class="info-value">${this.esc(c.role)}</span></div>` : ''}${c.phone ? `<div class="info-row"><span class="info-label">Telefon:</span><span class="info-value">${this.esc(c.phone)}</span></div>` : ''}${c.email ? `<div class="info-row"><span class="info-label">E-Mail:</span><span class="info-value">${this.esc(c.email)}</span></div>` : ''}</div>`).join('')}</div>` : ''}
${mengenHtml}
${toolsLegendHtml}
<h2 style="margin-top:20px"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg> Fotos (${photos.length})</h2>
${photosHtml || '<p>Keine Fotos vorhanden</p>'}
<div class="page-logo"><img src="data:image/png;base64,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" alt="QFM"></div>
<div style="height:60px" class="no-print"></div>
</body></html>`;
            
            // iOS-kompatible Methode: Zeige PDF in einem Fullscreen-Overlay
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            if (isIOS) {
                // iOS: Zeige in einem Overlay mit Share-Funktion
                this.showPDFOverlay(html, 'Projektbericht_' + (this.currentProject.projectNumber || this.currentProject.id));
            } else {
                // Desktop: Normales Popup
                const w = window.open('', '_blank');
                if (w) {
                    w.document.write(html);
                    w.document.close();
                    await this._waitForImages(w.document);
                    setTimeout(() => w.print(), 300);
                } else {
                    // Popup blockiert - Fallback
                    this.showPDFOverlay(html, 'Projektbericht_' + (this.currentProject.projectNumber || this.currentProject.id));
                }
            }
        }
        
        showPDFOverlay(html, filename) {
            // Entferne eventuell vorhandenes Overlay
            const existing = document.getElementById('pdfOverlay');
            if (existing) existing.remove();
            
            // Erstelle Overlay
            const overlay = document.createElement('div');
            overlay.id = 'pdfOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:#fff;z-index:10000;display:flex;flex-direction:column;';
            
            // Toolbar
            const toolbar = document.createElement('div');
            toolbar.style.cssText = 'display:flex;gap:10px;padding:12px 16px;background:#003C71;align-items:center;flex-shrink:0;padding-top:calc(12px + env(safe-area-inset-top));';
            toolbar.innerHTML = `
                <button onclick="document.getElementById('pdfOverlay').remove()" style="background:#fff;color:#003C71;border:none;padding:10px 16px;border-radius:8px;font-weight:600;font-size:14px;"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg> Zurück</button>
                <span style="flex:1;color:#fff;font-weight:600;font-size:14px;text-align:center;">${this.esc(filename)}</span>
                <button onclick="app.printPDFOverlay()" style="background:#fff;color:#003C71;border:none;padding:10px 16px;border-radius:8px;font-weight:600;font-size:14px;"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg> Drucken</button>
            `;
            
            // iFrame für den Inhalt
            const iframe = document.createElement('iframe');
            iframe.id = 'pdfIframe';
            iframe.style.cssText = 'flex:1;border:none;width:100%;';
            
            overlay.appendChild(toolbar);
            overlay.appendChild(iframe);
            document.body.appendChild(overlay);
            
            // Schreibe HTML in iframe
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(html);
            doc.close();
            
            this.toast('Tippe auf "Drucken" um als PDF zu speichern', 'info');
        }
        
        async printPDFOverlay() {
            const iframe = document.getElementById('pdfIframe');
            if (iframe && iframe.contentWindow) {
                await this._waitForImages(iframe.contentDocument);
                iframe.contentWindow.print();
            }
        }
        async exportQuantityPDF() {
            if (!this.currentProject) return;
            const photos = await this.db.getByIndex('photos', 'projectId', this.currentProject.id);
            const qty = {};
            const addQty = (key, name, unit, type='line') => { if (!qty[key]) qty[key] = { tool: { name, unit, type }, auto: 0 }; };
            Object.values(TOOLS).filter(t => t.unit && t.id !== 'TRASSE').forEach(t => { qty[t.id] = { tool: t, auto: 0 }; });
            photos.forEach(ph => (ph.annotations||[]).forEach(a => {
                const t = TOOLS[a.tool]; if (!t || !t.unit) return;
                if (a.tool === 'TRASSE') {
                    a.meta = a.meta || {};
                    const surf = a.meta.surface || 'GEHWEGPLATTE';
                    const dn = a.meta.dn || 'DN50';
                    const surfLabel = (SURFACES.find(s=>s.value===surf)||{label:surf}).label;
                    const dnLabel = (DNS.find(d=>d.value===dn)||{label:dn}).label;
                    addQty('TRASSE_TOTAL', 'Trasse gesamt', t.unit);
                    addQty(`TRASSE_DN_${dn}`, dnLabel, t.unit);
                    addQty(`TRASSE_SURF_${surf}`, surfLabel, t.unit);
                    if (a.computed?.lengthMeters) {
                        qty['TRASSE_TOTAL'].auto += a.computed.lengthMeters;
                        qty[`TRASSE_DN_${dn}`].auto += a.computed.lengthMeters;
                        qty[`TRASSE_SURF_${surf}`].auto += a.computed.lengthMeters;
                    }
                } else if (t.type === 'line' && a.computed?.lengthMeters) {
                    qty[t.id].auto += a.computed.lengthMeters;
                } else if (t.type === 'point') {
                    qty[t.id].auto += 1;
                }
            }));
            const saved = this.currentProject.quantities || {};
            const keys = Object.keys(qty).sort((a,b) => {
                const orderValue = k => k==='TRASSE_TOTAL'?0: k.startsWith('TRASSE_DN_')?1: k.startsWith('TRASSE_SURF_')?2:3;
                const oa = orderValue(a), ob = orderValue(b);
                if (oa !== ob) return oa - ob;
                return this.qtyLabel(a, qty[a].tool).localeCompare(this.qtyLabel(b, qty[b].tool), 'de');
            });
            let pos = 1, rows = keys.map(id => {
                const q = qty[id];
                const val = saved[id] !== undefined ? saved[id] : q.auto;
                const name = this.qtyLabel(id, q.tool);
                return `<tr><td>${pos++}</td><td>${name}</td><td>${q.tool.unit}</td><td style="text-align:right">${q.tool.type==='line'?val.toFixed(1):val}</td></tr>`;
            }).join('');
            
            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Mengenaufmaß - ${this.esc(this.currentProject.projectName)}</title>
<link href='https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap' rel='stylesheet'>
<style>
@page { size: landscape; margin: 15mm; }
@media print {
    @page { size: landscape; margin: 15mm; }
    .no-print { display: none !important; }
    body { padding: 0; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
}
body { font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif; padding: 20px; background: #fff; }
h1 { color: #003C71; font-weight: 700; margin-bottom: 20px; }
.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.info-section { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
.info-section-title { font-weight: bold; color: #003C71; margin-bottom: 10px; font-size: 13px; text-transform: uppercase; }
.info-row { margin: 5px 0; font-size: 13px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid #ddd; padding: 10px; }
th { background: #003C71; color: white; }
.print-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #003C71; padding: 15px 20px; display: flex; gap: 10px; justify-content: center; z-index: 1000; }
.print-bar button { background: white; color: #003C71; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; min-width: 120px; }
.print-bar button:active { background: #d0d3d4; }
.page-logo { position: fixed; bottom: 5mm; right: 5mm; opacity: 0.7; z-index: 9999; }
.page-logo img { height: 36px; }
</style></head><body>

<div class="print-bar no-print">
    <button onclick="window.print()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg> Drucken</button>
    <button onclick="window.close()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> Schließen</button>
</div>

<div style="display:flex;align-items:center;gap:15px;margin-bottom:20px">
    <img src="data:image/png;base64,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" alt="SiteSketch" style="height:40px">
    <h1 style="margin:0;flex:1">Mengenaufmaß</h1>
</div>

<div class="info-grid">
    <div class="info-section">
        <div class="info-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg> Projekt</div>
        <div class="info-row"><b>Nummer:</b> ${this.esc(this.currentProject.projectNumber||'-')}</div>
        <div class="info-row"><b>Name:</b> ${this.esc(this.currentProject.projectName)}</div>
    </div>
    <div class="info-section">
        <div class="info-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Kunde</div>
        <div class="info-row"><b>Name:</b> ${this.esc(this.currentProject.customer)}</div>
        <div class="info-row"><b>Standort:</b> ${this.esc(this.currentProject.location||'')}</div>
    </div>
    <div class="info-section">
        <div class="info-section-title"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ed6d0f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;display:inline-block;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Ersteller</div>
        <div class="info-row"><b>Name:</b> ${this.esc(this.currentProject.creator||'-')}</div>
        <div class="info-row"><b>Datum:</b> ${new Date().toLocaleDateString('de-DE')}</div>
    </div>
</div>

<table>
    <tr><th>Pos.</th><th>Beschreibung</th><th>Einheit</th><th style="text-align:right">Menge</th></tr>
    ${rows}
</table>


<div class="page-logo"><img src="data:image/png;base64,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" alt="QFM"></div>
<div style="height:80px" class="no-print"></div>
</body></html>`;
            
            // iOS-kompatible Methode
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            if (isIOS) {
                this.showPDFOverlay(html, 'Mengenaufmass_' + (this.currentProject.projectNumber || this.currentProject.id));
            } else {
                const w = window.open('', '_blank');
                if (w) {
                    w.document.write(html);
                    w.document.close();
                    await this._waitForImages(w.document);
                    setTimeout(() => w.print(), 300);
                } else {
                    this.showPDFOverlay(html, 'Mengenaufmass_' + (this.currentProject.projectNumber || this.currentProject.id));
                }
            }
        }

        // Wartet bis alle Bilder in einem Dokument geladen sind (für PDF-Druck)
        _waitForImages(doc) {
            return new Promise(resolve => {
                const imgs = doc.querySelectorAll('img');
                const pending = Array.from(imgs).filter(img => !img.complete);
                if (pending.length === 0) { resolve(); return; }
                let loaded = 0;
                const check = () => { if (++loaded >= pending.length) resolve(); };
                pending.forEach(img => { img.onload = check; img.onerror = check; });
                // Sicherheits-Timeout: nach 10s trotzdem drucken
                setTimeout(resolve, 10000);
            });
        }

        readFile(f) { return new Promise((r,e) => { const fr = new FileReader(); fr.onload = () => r(fr.result); fr.onerror = e; fr.readAsDataURL(f); }); }
        createThumb(dataUrl, max) { return new Promise(r => { const img = new Image(); img.onload = () => { const c = document.createElement('canvas'), s = Math.min(max/img.width, max/img.height, 1); c.width = img.width*s; c.height = img.height*s; c.getContext('2d').drawImage(img, 0, 0, c.width, c.height); r(c.toDataURL('image/jpeg', 0.7)); }; img.src = dataUrl; }); }
        esc(s) { return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
        toast(msg, type='info') { const c = document.getElementById('toastContainer'), t = document.createElement('div'); t.className = 'toast ' + type; t.textContent = msg; c.appendChild(t); setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000); }
    }

    const app = new App();
    window.app = app; // Make app globally accessible
    app.init();
    window.addEventListener('resize', () => { if (app.map) app.map.invalidateSize(); });
    </script>
</body>
</html>
